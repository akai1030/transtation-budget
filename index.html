<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TranStation OS | 希卡預算系統</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --sheikah-bg: #F0F2E8; /* Snow Peak 帆布白 */
            --sheikah-dark: #2D2D2D; /* 深岩石灰 */
            --sheikah-orange: #FF4D00; /* 希卡螢光橘 */
            --sheikah-blue: #00E0FF; /* 希卡能量藍 */
            --glass-border: rgba(45, 45, 45, 0.1);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--sheikah-bg);
            color: var(--sheikah-dark);
            /* 希卡地圖網格背景 */
            background-image: 
                linear-gradient(var(--glass-border) 1px, transparent 1px),
                linear-gradient(90deg, var(--glass-border) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* 數字字體 */
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* 希卡面板 */
        .sheikah-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        /* 裝飾線條 (角落) */
        .corner-deco::before, .corner-deco::after {
            content: ''; position: absolute; width: 10px; height: 10px;
            border: 1px solid var(--sheikah-orange); transition: all 0.3s ease;
        }
        .corner-deco::before { top: 0; left: 0; border-right: none; border-bottom: none; }
        .corner-deco::after { bottom: 0; right: 0; border-left: none; border-top: none; }

        /* 輸入框 */
        .sheikah-input {
            background: transparent;
            border-bottom: 1px solid #CCC;
            border-radius: 0;
            transition: all 0.3s;
        }
        .sheikah-input:focus {
            outline: none;
            border-bottom: 1px solid var(--sheikah-orange);
            background: rgba(255, 77, 0, 0.03);
        }

        /* 按鈕風格 (Snow Peak x Sheikah) */
        .btn-sheikah {
            border: 1px solid var(--sheikah-orange);
            color: var(--sheikah-orange);
            background: transparent;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-sheikah:hover {
            background: var(--sheikah-orange);
            color: white;
            box-shadow: 0 0 10px rgba(255, 77, 0, 0.3);
        }
        .btn-sheikah-fill {
            background: var(--sheikah-orange);
            color: white;
            border: 1px solid var(--sheikah-orange);
        }
        .btn-sheikah-fill:hover {
            background: #E04400;
        }

        /* 頁籤切換 */
        .tab-btn {
            border-bottom: 2px solid transparent;
            opacity: 0.5;
        }
        .tab-btn.active {
            border-bottom: 2px solid var(--sheikah-orange);
            opacity: 1;
            color: var(--sheikah-orange);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-xl">
        
        <div class="mb-6 flex justify-between items-end">
            <div>
                <h1 class="text-xs font-bold tracking-[0.2em] text-stone-400 mb-1">TranStation Lab</h1>
                <h2 class="text-2xl font-light tracking-widest text-stone-800">BUDGET <span class="text-[#FF4D00]">OS</span></h2>
            </div>
            <div class="flex items-center space-x-2 text-xs text-stone-400">
                <span :class="loading ? 'bg-yellow-400 animate-pulse' : 'bg-[#FF4D00]'" class="w-2 h-2 rounded-full"></span>
                <span>{{ loading ? 'SYNCING...' : 'ONLINE' }}</span>
            </div>
        </div>

        <div class="sheikah-panel rounded-lg p-6 corner-deco">
            
            <div class="flex space-x-6 mb-8 border-b border-stone-200 pb-1">
                <button @click="currentTab = 'record'" :class="{active: currentTab === 'record'}" class="tab-btn pb-2 text-sm font-bold tracking-wide transition-all">
                    支出記帳
                </button>
                <button @click="currentTab = 'status'" :class="{active: currentTab === 'status'}" class="tab-btn pb-2 text-sm font-bold tracking-wide transition-all">
                    專案儀表板
                </button>
                <button @click="currentTab = 'transfer'" :class="{active: currentTab === 'transfer'}" class="tab-btn pb-2 text-sm font-bold tracking-wide transition-all">
                    撥補零用金
                </button>
            </div>

            <div v-if="currentTab === 'record'" class="animate-fade-in space-y-6">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] text-stone-400 uppercase tracking-widest">DATE</label>
                        <input type="date" v-model="form.date" class="sheikah-input w-full py-2 text-sm font-mono">
                    </div>
                    <div>
                        <label class="text-[10px] text-stone-400 uppercase tracking-widest">PAYER</label>
                        <select v-model="form.payer" class="sheikah-input w-full py-2 text-sm">
                            <option disabled value="">Select User</option>
                            <option v-for="u in users" :key="u.id" :value="u.name">{{ u.name }} (剩${{u.pettyCash}})</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] text-stone-400 uppercase tracking-widest mb-2 block">METHOD</label>
                    <div class="flex space-x-3">
                        <button @click="form.paymentType = '零用金'" 
                            :class="form.paymentType === '零用金' ? 'btn-sheikah-fill' : 'border border-stone-300 text-stone-400'"
                            class="flex-1 py-2 text-xs rounded transition-all">
                            公款零用金
                        </button>
                        <button @click="form.paymentType = '代墊'" 
                            :class="form.paymentType === '代墊' ? 'btn-sheikah-fill' : 'border border-stone-300 text-stone-400'"
                            class="flex-1 py-2 text-xs rounded transition-all">
                            個人代墊
                        </button>
                    </div>
                </div>

                <div class="pt-4 border-t border-dashed border-stone-200">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-bold text-stone-500">ITEMS LIST</span>
                        <span class="text-sm font-mono font-bold text-[#FF4D00]">TOTAL: ${{ totalAmount }}</span>
                    </div>

                    <div v-for="(item, index) in form.items" :key="index" class="mb-4 relative group">
                        <button v-if="form.items.length > 1" @click="removeItem(index)" type="button" class="absolute -left-6 top-2 text-stone-300 hover:text-red-500">×</button>
                        <div class="flex space-x-2 mb-2">
                            <select v-model="item.projectId" class="flex-[2] sheikah-input py-1 text-sm bg-stone-50/50">
                                <option disabled value="">Project...</option>
                                <option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</option>
                            </select>
                            <input type="number" v-model.number="item.amount" placeholder="$$" class="flex-1 sheikah-input py-1 text-sm text-right font-mono">
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" v-model="item.itemName" placeholder="Item Name" class="flex-[2] sheikah-input py-1 text-xs">
                            <input type="text" v-model="item.note" placeholder="Note" class="flex-1 sheikah-input py-1 text-xs text-stone-400">
                        </div>
                    </div>

                    <button @click="addItem" type="button" class="w-full py-2 border border-dashed border-stone-300 text-stone-400 text-xs hover:border-[#FF4D00] hover:text-[#FF4D00] transition-colors">
                        + ADD ITEM
                    </button>
                </div>

                <button @click="submitForm" class="w-full btn-sheikah py-3 mt-4 text-sm tracking-widest uppercase">
                    EXECUTE RECORD
                </button>
            </div>

            <div v-if="currentTab === 'status'" class="animate-fade-in">
                <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                    
                    <div v-for="(stat, pid) in projectStats" :key="pid" class="border border-stone-200 p-4 rounded bg-white/40">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-sm font-bold text-stone-700">{{ stat.name }}</h3>
                            <span :class="stat.balance >= 0 ? 'text-stone-500' : 'text-red-500'" class="font-mono text-xs font-bold">
                                {{ stat.balance >= 0 ? '結餘' : '超支' }} ${{ stat.balance }}
                            </span>
                        </div>
                        
                        <div class="h-1 w-full bg-stone-200 mb-3 overflow-hidden rounded-full">
                            <div class="h-full bg-[#FF4D00]" :style="{width: calculateProgress(stat.totalExpense, stat.totalIncome) + '%'}"></div>
                        </div>

                        <div class="flex justify-between text-xs text-stone-500 font-mono">
                            <div>
                                <span class="block text-[10px] text-stone-400">INCOME</span>
                                ${{ stat.totalIncome }}
                            </div>
                            <div class="text-right">
                                <span class="block text-[10px] text-stone-400">EXPENSE</span>
                                ${{ stat.totalExpense }}
                            </div>
                        </div>
                    </div>

                </div>
                <div class="mt-4 text-[10px] text-stone-400 text-center">
                    * INTERNAL 專案為公司資產/內部轉帳
                </div>
            </div>

            <div v-if="currentTab === 'transfer'" class="animate-fade-in space-y-6">
                <div class="bg-orange-50 border border-orange-100 p-4 rounded text-xs text-orange-800 mb-4">
                    ⚠️ 此功能為「公司撥款」給成員，將增加成員身上的零用金餘額，不計入專案成本。
                </div>

                <div>
                    <label class="text-[10px] text-stone-400 uppercase tracking-widest">TARGET USER</label>
                    <select v-model="transferForm.targetUser" class="sheikah-input w-full py-2 text-sm">
                        <option disabled value="">選擇收款人</option>
                        <option v-for="u in users" :key="u.id" :value="u.name">{{ u.name }} (目前餘額 ${{u.pettyCash}})</option>
                    </select>
                </div>

                <div>
                    <label class="text-[10px] text-stone-400 uppercase tracking-widest">AMOUNT</label>
                    <input type="number" v-model.number="transferForm.amount" placeholder="$$" class="sheikah-input w-full py-2 text-2xl font-mono text-[#FF4D00]">
                </div>

                <div>
                    <label class="text-[10px] text-stone-400 uppercase tracking-widest">NOTE</label>
                    <input type="text" v-model="transferForm.note" placeholder="例如：12月零用金補充" class="sheikah-input w-full py-2 text-sm">
                </div>

                <button @click="submitTransfer" class="w-full btn-sheikah py-3 mt-8 text-sm tracking-widest uppercase">
                    CONFIRM TRANSFER
                </button>
            </div>

        </div>

        <p class="text-center text-stone-300 text-[10px] mt-6 tracking-widest font-mono">TS-LAB v3.0 // SYSTEM NORMAL</p>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        // 記得檢查網址是否為最新版
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyKtICKtLnl01vytLz90174UICy1bfdMbKQdRqeZX3KOhyQGwJNQyXQDouxnXXfEfLQ/exec';

        createApp({
            setup() {
                const currentTab = ref('record');
                const loading = ref(true);
                const projects = ref([]);
                const users = ref([]);
                const projectStats = ref({});
                
                // 記帳表單
                const form = ref({
                    date: new Date().toISOString().split('T')[0],
                    payer: '',
                    paymentType: '零用金',
                    items: [{ projectId: '', itemName: '', amount: '', note: '' }]
                });

                // 撥補表單
                const transferForm = ref({
                    date: new Date().toISOString().split('T')[0],
                    targetUser: '',
                    amount: '',
                    note: '',
                    action: 'replenish' // 標記為撥補動作
                });

                const totalAmount = computed(() => form.value.items.reduce((sum, item) => sum + (Number(item.amount) || 0), 0));

                const loadData = async () => {
                    try {
                        const res = await fetch(`${GAS_API_URL}?op=getData`);
                        const data = await res.json();
                        projects.value = data.projects;
                        users.value = data.users;
                        projectStats.value = data.projectStats;
                        loading.value = false;
                    } catch (e) {
                        alert('連線錯誤');
                        console.error(e);
                    }
                };

                onMounted(() => loadData());

                const addItem = () => form.value.items.push({ projectId: '', itemName: '', amount: '', note: '' });
                const removeItem = (index) => form.value.items.splice(index, 1);
                
                // 計算進度條百分比
                const calculateProgress = (spent, income) => {
                    if (!income || income === 0) return 0;
                    return Math.min((spent / income) * 100, 100);
                };

                const submitForm = async () => {
                    if(!form.value.payer) return alert('請選擇付款人');
                    loading.value = true;
                    try {
                        const payload = { ...form.value, totalAmount: totalAmount.value };
                        await fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload),
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                        });
                        alert('✅ 記帳完成');
                        form.value.items = [{ projectId: '', itemName: '', amount: '', note: '' }];
                        await loadData();
                    } catch (e) {
                        alert('❌ 失敗');
                    } finally {
                        loading.value = false;
                    }
                };

                const submitTransfer = async () => {
                    if(!transferForm.value.targetUser || !transferForm.value.amount) return alert('請填寫完整');
                    loading.value = true;
                    try {
                        await fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(transferForm.value),
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                        });
                        alert('✅ 撥補完成');
                        transferForm.value.amount = '';
                        transferForm.value.note = '';
                        await loadData();
                    } catch (e) {
                        alert('❌ 失敗');
                    } finally {
                        loading.value = false;
                    }
                };

                return { 
                    currentTab, loading, projects, users, projectStats, 
                    form, transferForm, totalAmount, 
                    addItem, removeItem, submitForm, submitTransfer, calculateProgress 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>