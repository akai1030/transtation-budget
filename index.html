<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TranStation OS | è½‰é§…å‰µç ” é ç®—ç³»çµ±</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --sheikah-bg: #F0F2E8; 
            --sheikah-dark: #2D2D2D;
            --sheikah-orange: #FF4D00;
            --glass-border: rgba(45, 45, 45, 0.1);
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--sheikah-bg);
            color: var(--sheikah-dark);
            background-image: 
                linear-gradient(var(--glass-border) 1px, transparent 1px),
                linear-gradient(90deg, var(--glass-border) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .sheikah-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        .corner-deco::before, .corner-deco::after {
            content: ''; position: absolute; width: 10px; height: 10px;
            border: 1px solid var(--sheikah-orange); transition: all 0.3s ease;
        }
        .corner-deco::before { top: 0; left: 0; border-right: none; border-bottom: none; }
        .corner-deco::after { bottom: 0; right: 0; border-left: none; border-top: none; }
        .sheikah-input {
            background: transparent; border-bottom: 1px solid #CCC; border-radius: 0; transition: all 0.3s;
        }
        .sheikah-input:focus { outline: none; border-bottom: 1px solid var(--sheikah-orange); background: rgba(255, 77, 0, 0.03); }
        .btn-sheikah { border: 1px solid var(--sheikah-orange); color: var(--sheikah-orange); background: transparent; font-weight: 500; transition: all 0.2s; }
        .btn-sheikah:hover { background: var(--sheikah-orange); color: white; }
        .tab-btn { border-bottom: 2px solid transparent; opacity: 0.5; }
        .tab-btn.active { border-bottom: 2px solid var(--sheikah-orange); opacity: 1; color: var(--sheikah-orange); }
        .progress-container { background: #E5E7EB; border-radius: 99px; height: 6px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.5s ease; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-xl">
        <div class="mb-6 flex justify-between items-end">
            <div>
                <h1 class="text-xs font-bold tracking-[0.2em] text-stone-400 mb-1">TranStation Lab</h1>
                <h2 class="text-2xl font-light tracking-widest text-stone-800">BUDGET <span class="text-[#FF4D00]">OS v5</span></h2>
            </div>
            <div class="flex items-center space-x-2 text-xs text-stone-400">
                <span :class="loading ? 'bg-yellow-400 animate-pulse' : 'bg-[#FF4D00]'" class="w-2 h-2 rounded-full"></span>
                <span>{{ loading ? 'SYNCING...' : 'ONLINE' }}</span>
            </div>
        </div>

        <div class="sheikah-panel rounded-lg p-6 corner-deco min-h-[500px]">
            
            <div class="flex space-x-4 mb-6 border-b border-stone-200 pb-1 overflow-x-auto">
                <button @click="currentTab='record'" :class="{active: currentTab==='record'}" class="tab-btn pb-2 text-sm font-bold whitespace-nowrap">æ”¯å‡ºè¨˜å¸³</button>
                <button @click="currentTab='income'" :class="{active: currentTab==='income'}" class="tab-btn pb-2 text-sm font-bold whitespace-nowrap">é€²å¸³ç®¡ç†</button>
                <button @click="currentTab='status'" :class="{active: currentTab==='status'}" class="tab-btn pb-2 text-sm font-bold whitespace-nowrap">å°ˆæ¡ˆå„€è¡¨æ¿</button>
                <button @click="currentTab='transfer'" :class="{active: currentTab==='transfer'}" class="tab-btn pb-2 text-sm font-bold whitespace-nowrap">æ’¥è£œé›¶ç”¨é‡‘</button>
            </div>

            <div v-if="currentTab === 'record'" class="space-y-6">
                <div class="grid grid-cols-2 gap-6">
                    <div><label class="text-[10px] text-stone-400">DATE</label><input type="date" v-model="form.date" class="sheikah-input w-full py-2 text-sm font-mono"></div>
                    <div>
                        <label class="text-[10px] text-stone-400">PAYER</label>
                        <select v-model="form.payer" class="sheikah-input w-full py-2 text-sm"><option disabled value="">é¸æ“‡ä»˜æ¬¾äºº</option><option v-for="u in users" :key="u.id" :value="u.name">{{ u.name }} (${{u.pettyCash}})</option></select>
                    </div>
                </div>
                <div>
                    <div class="flex space-x-3 mt-2">
                        <button @click="form.paymentType='é›¶ç”¨é‡‘'" :class="form.paymentType==='é›¶ç”¨é‡‘'?'bg-[#FF4D00] text-white':'text-stone-400 border border-stone-300'" class="flex-1 py-1 text-xs rounded">å…¬æ¬¾é›¶ç”¨é‡‘</button>
                        <button @click="form.paymentType='ä»£å¢Š'" :class="form.paymentType==='ä»£å¢Š'?'bg-[#FF4D00] text-white':'text-stone-400 border border-stone-300'" class="flex-1 py-1 text-xs rounded">å€‹äººä»£å¢Š</button>
                    </div>
                </div>
                <div class="pt-4 border-t border-dashed border-stone-200">
                    <div class="flex justify-between items-center mb-4"><span class="text-xs font-bold text-stone-500">æ˜ç´°åˆ—è¡¨</span><span class="text-sm font-mono font-bold text-[#FF4D00]">Total: ${{ totalAmount }}</span></div>
                    <div v-for="(item, index) in form.items" :key="index" class="mb-4 relative">
                        <button v-if="form.items.length>1" @click="removeItem(index)" type="button" class="absolute -left-5 top-2 text-red-400">Ã—</button>
                        <div class="flex space-x-2 mb-2"><select v-model="item.projectId" class="flex-[2] sheikah-input py-1 text-sm"><option disabled value="">å°ˆæ¡ˆ...</option><option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</option></select><input type="number" v-model.number="item.amount" placeholder="$$" class="flex-1 sheikah-input py-1 text-sm text-right font-mono"></div>
                        <div class="flex space-x-2"><input type="text" v-model="item.itemName" placeholder="å“é …" class="flex-[2] sheikah-input py-1 text-xs"><input type="text" v-model="item.note" placeholder="å‚™è¨»" class="flex-1 sheikah-input py-1 text-xs text-stone-400"></div>
                    </div>
                    <button @click="addItem" class="w-full py-2 border border-dashed border-stone-300 text-stone-400 text-xs hover:border-[#FF4D00] hover:text-[#FF4D00]">+ æ–°å¢æ˜ç´°</button>
                </div>
                <button @click="submitForm" class="w-full btn-sheikah py-3 text-sm tracking-widest">ç¢ºèªè¨˜å¸³</button>
            </div>

            <div v-if="currentTab === 'income'" class="space-y-6">
                
                <div class="border border-stone-200 p-4 rounded-lg bg-white/40">
                    <h3 class="text-xs font-bold text-stone-500 mb-2">ï¼‹ å»ºç«‹æ–°å°ˆæ¡ˆ</h3>
                    <div class="flex space-x-2">
                        <input type="text" v-model="newProjectName" placeholder="è¼¸å…¥å°ˆæ¡ˆåç¨± (ä¾‹: 2025 Taitung Fest)" class="sheikah-input flex-1 text-sm">
                        <button @click="submitCreateProject" class="bg-stone-800 text-white px-4 py-1 text-xs rounded hover:bg-[#FF4D00] transition-colors">å»ºç«‹</button>
                    </div>
                </div>

                <div class="bg-white/50 p-4 border border-stone-200 rounded-lg">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold text-[#FF4D00]">é ç®—è¨­å®š</h3>
                        <div class="flex bg-stone-100 rounded p-0.5">
                            <button @click="incomeMode='single'" :class="incomeMode==='single'?'bg-white shadow text-[#FF4D00]':'text-stone-400'" class="px-3 py-1 text-[10px] rounded transition-all">å–®ç­†</button>
                            <button @click="incomeMode='batch'" :class="incomeMode==='batch'?'bg-white shadow text-[#FF4D00]':'text-stone-400'" class="px-3 py-1 text-[10px] rounded transition-all">æ‰¹æ¬¡</button>
                        </div>
                    </div>

                    <select v-model="incomeProjectId" class="sheikah-input text-sm w-full mb-3">
                        <option disabled value="">é¸æ“‡ç›®æ¨™å°ˆæ¡ˆ...</option>
                        <option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</option>
                    </select>
                    
                    <div v-if="incomeMode==='single'" class="grid grid-cols-2 gap-3 animate-fade-in">
                        <input type="text" v-model="incomeForm.termName" placeholder="æœŸæ•¸åç¨± (ä¾‹: è¨‚é‡‘)" class="sheikah-input text-sm">
                        <input type="number" v-model.number="incomeForm.expectedAmount" placeholder="é‡‘é¡" class="sheikah-input text-sm font-mono">
                        <input type="date" v-model="incomeForm.expectedDate" class="sheikah-input text-sm font-mono col-span-2">
                        <button @click="submitIncome" class="col-span-2 w-full bg-stone-200 text-stone-600 py-2 text-xs rounded hover:bg-[#FF4D00] hover:text-white transition-colors">åŠ å…¥å–®ç­†é ç®—</button>
                    </div>

                    <div v-if="incomeMode==='batch'" class="grid grid-cols-2 gap-3 animate-fade-in">
                        <div class="col-span-2 text-[10px] text-stone-400">å°‡è‡ªå‹•ç”¢ç”Ÿ N ç­†æ¬¾é …ï¼Œæ—¥æœŸæ¯æœˆéå¢</div>
                        <input type="number" v-model.number="batchForm.count" placeholder="ç¸½å…±å¹¾æœŸ" class="sheikah-input text-sm">
                        <input type="number" v-model.number="batchForm.amountPerTerm" placeholder="æ¯æœŸé‡‘é¡" class="sheikah-input text-sm font-mono">
                        <div class="col-span-2">
                            <label class="text-[10px] text-stone-400">ç¬¬ä¸€æœŸæ”¶æ¬¾æ—¥</label>
                            <input type="date" v-model="batchForm.startDate" class="sheikah-input w-full text-sm font-mono">
                        </div>
                        <button @click="submitBatchIncome" class="col-span-2 w-full bg-stone-800 text-white py-2 text-xs rounded hover:bg-[#FF4D00] transition-colors">
                            æ‰¹æ¬¡ç”¢ç”Ÿ {{batchForm.count}} ç­†é ç®—
                        </button>
                    </div>
                </div>

                <div class="space-y-4 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar">
                    <div v-for="(stat, pid) in projectStats" :key="pid">
                        <div v-if="stat.incomeTerms && stat.incomeTerms.length > 0">
                            <h4 class="text-xs font-bold text-stone-500 mb-2 mt-4 border-b pb-1">{{ stat.name }}</h4>
                            <div v-for="term in stat.incomeTerms" :key="term.id" class="flex justify-between items-center bg-white p-3 mb-2 rounded border border-stone-100 shadow-sm">
                                <div>
                                    <div class="text-sm font-bold text-stone-700">{{ term.termName }}</div>
                                    <div class="text-[10px] text-stone-400 font-mono">é è¨ˆ: {{ term.expDate }} / ${{ term.expAmt }}</div>
                                </div>
                                <div class="text-right">
                                    <button v-if="term.status === 'pending'" @click="receiveMoney(term)" class="border border-stone-300 text-stone-400 px-3 py-1 text-xs rounded hover:border-[#FF4D00] hover:text-[#FF4D00]">ç¢ºèªæ”¶æ¬¾</button>
                                    <div v-else class="text-[#FF4D00] text-xs font-bold border border-[#FF4D00] px-2 py-1 rounded bg-orange-50">å·²å…¥å¸³ ${{ term.actAmt }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'status'" class="space-y-4 overflow-y-auto max-h-[450px] pr-2">
                <div v-for="(stat, pid) in projectStats" :key="pid" class="border border-stone-200 p-4 rounded bg-white/60 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <h3 class="text-sm font-bold text-stone-700">{{ stat.name }}</h3>
                        <span :class="stat.balance >= 0 ? 'text-stone-500' : 'text-red-500'" class="font-mono text-xs font-bold">ç¾é‡‘æµ ${{ stat.balance }}</span>
                    </div>
                    <div class="text-[10px] text-stone-400 mb-1 flex justify-between"><span>é ç®—æ¶ˆè€— (${{stat.totalExpense}} / ${{stat.totalBudget}})</span></div>
                    <div class="progress-container mb-3"><div class="progress-bar bg-[#FF4D00]" :style="{width: calcPercent(stat.totalExpense, stat.totalBudget) + '%'}"></div></div>
                    <div class="text-[10px] text-stone-400 mb-1 flex justify-between"><span>è³‡é‡‘å›æ”¶ (${{stat.totalReceived}} / ${{stat.totalBudget}})</span></div>
                    <div class="progress-container"><div class="progress-bar bg-stone-600" :style="{width: calcPercent(stat.totalReceived, stat.totalBudget) + '%'}"></div></div>
                </div>
            </div>

            <div v-if="currentTab === 'transfer'" class="space-y-6">
                <div class="bg-orange-50 text-orange-800 p-3 rounded text-xs border border-orange-100">æ­¤åŠŸèƒ½ç‚ºå…¬å¸æ’¥æ¬¾çµ¦æˆå“¡ï¼Œä¸è¨ˆå…¥å°ˆæ¡ˆæˆæœ¬ã€‚</div>
                <div><label class="text-[10px] text-stone-400">æ”¶æ¬¾äºº</label><select v-model="transferForm.targetUser" class="sheikah-input w-full py-2 text-sm"><option disabled value="">é¸æ“‡...</option><option v-for="u in users" :key="u.id" :value="u.name">{{ u.name }} (${{u.pettyCash}})</option></select></div>
                <div><label class="text-[10px] text-stone-400">é‡‘é¡</label><input type="number" v-model.number="transferForm.amount" class="sheikah-input w-full py-2 text-2xl font-mono text-[#FF4D00]"></div>
                <div><label class="text-[10px] text-stone-400">å‚™è¨»</label><input type="text" v-model="transferForm.note" class="sheikah-input w-full py-2 text-sm"></div>
                <button @click="submitTransfer" class="w-full btn-sheikah py-3 mt-4 text-sm tracking-widest">ç¢ºèªæ’¥æ¬¾</button>
            </div>
        </div>
        <p class="text-center text-stone-300 text-[10px] mt-6 tracking-widest font-mono">TranStation Lab v5.0</p>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        // âš ï¸ è«‹ç¢ºèªé€™æ˜¯æœ€æ–°çš„ GAS ç¶²å€
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyKtICKtLnl01vytLz90174UICy1bfdMbKQdRqeZX3KOhyQGwJNQyXQDouxnXXfEfLQ/exec';

        createApp({
            setup() {
                const currentTab = ref('record');
                const loading = ref(true);
                const projects = ref([]);
                const users = ref([]);
                const projectStats = ref({});
                const incomeMode = ref('single'); // single or batch
                
                // Forms
                const form = ref({ date: new Date().toISOString().split('T')[0], payer: '', paymentType: 'é›¶ç”¨é‡‘', items: [{ projectId: '', itemName: '', amount: '', note: '' }] });
                const transferForm = ref({ date: new Date().toISOString().split('T')[0], targetUser: '', amount: '', note: '', action: 'replenish' });
                
                // æ–°å¢å°ˆæ¡ˆ & é ç®— Forms
                const newProjectName = ref('');
                const incomeProjectId = ref('');
                const incomeForm = ref({ termName: '', expectedAmount: '', expectedDate: '' });
                const batchForm = ref({ count: '', amountPerTerm: '', startDate: new Date().toISOString().split('T')[0] });

                const totalAmount = computed(() => form.value.items.reduce((sum, i) => sum + (Number(i.amount)||0), 0));

                const loadData = async () => {
                    try {
                        const res = await fetch(`${GAS_API_URL}?op=getData`);
                        const data = await res.json();
                        projects.value = data.projects;
                        users.value = data.users;
                        projectStats.value = data.projectStats;
                        loading.value = false;
                    } catch (e) { alert('é€£ç·šéŒ¯èª¤'); console.error(e); }
                };

                onMounted(() => loadData());
                const addItem = () => form.value.items.push({ projectId: '', itemName: '', amount: '', note: '' });
                const removeItem = (i) => form.value.items.splice(i, 1);
                const calcPercent = (curr, total) => (!total || total===0) ? 0 : Math.min((curr/total)*100, 100);

                // --- API Actions ---
                const submitCreateProject = async () => {
                    if(!newProjectName.value) return alert('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±');
                    loading.value = true;
                    try {
                        await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'createProject', projectName: newProjectName.value }), headers: {'Content-Type': 'text/plain'} });
                        alert('âœ¨ å°ˆæ¡ˆå·²å»ºç«‹'); newProjectName.value=''; await loadData();
                    } catch(e) { alert('å¤±æ•—'); } finally { loading.value = false; }
                };

                const submitBatchIncome = async () => {
                    if(!incomeProjectId.value || !batchForm.value.count || !batchForm.value.amountPerTerm) return alert('è³‡æ–™ä¸å…¨');
                    loading.value = true;
                    
                    // ç”¢ç”ŸæœŸæ•¸é™£åˆ—
                    const items = [];
                    let currentDate = new Date(batchForm.value.startDate);
                    
                    for(let i=0; i < batchForm.value.count; i++) {
                        const termDateStr = currentDate.toISOString().split('T')[0];
                        items.push({
                            projectId: incomeProjectId.value,
                            termName: `ç¬¬ ${i+1} æœŸ`,
                            expectedDate: termDateStr,
                            expectedAmount: batchForm.value.amountPerTerm
                        });
                        // æ—¥æœŸåŠ ä¸€å€‹æœˆ
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }

                    try {
                        await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'batchIncome', items: items }), headers: {'Content-Type': 'text/plain'} });
                        alert(`âœ… å·²ç”¢ç”Ÿ ${batchForm.value.count} ç­†é ç®—`); 
                        batchForm.value.count=''; batchForm.value.amountPerTerm=''; await loadData();
                    } catch(e) { alert('å¤±æ•—'); } finally { loading.value = false; }
                };

                const submitIncome = async () => {
                    if(!incomeProjectId.value || !incomeForm.value.expectedAmount) return alert('è³‡æ–™ä¸å…¨');
                    loading.value = true;
                    try {
                        const payload = { ...incomeForm.value, projectId: incomeProjectId.value, action: 'income' };
                        await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload), headers: {'Content-Type': 'text/plain'} });
                        alert('âœ… é ç®—å·²æ–°å¢'); incomeForm.value.termName=''; incomeForm.value.expectedAmount=''; await loadData();
                    } catch (e) { alert('å¤±æ•—'); } finally { loading.value = false; }
                };

                const submitForm = async () => {
                    if(!form.value.payer) return alert('è«‹é¸ä»˜æ¬¾äºº'); loading.value = true;
                    try { await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({...form.value, totalAmount: totalAmount.value}), headers: {'Content-Type': 'text/plain'} }); alert('âœ… è¨˜å¸³å®Œæˆ'); form.value.items=[{projectId:'',itemName:'',amount:'',note:''}]; await loadData(); } catch (e) { alert('å¤±æ•—'); } finally { loading.value = false; }
                };

                const submitTransfer = async () => {
                    if(!transferForm.value.targetUser) return alert('è«‹é¸äºº'); loading.value = true;
                    try { await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(transferForm.value), headers: {'Content-Type': 'text/plain'} }); alert('âœ… æ’¥æ¬¾å®Œæˆ'); transferForm.value.amount=''; await loadData(); } catch (e) { alert('å¤±æ•—'); } finally { loading.value = false; }
                };

                const receiveMoney = async (term) => {
                    const actualAmt = prompt(`ç¢ºèªæ”¶æ¬¾ï¼Ÿ\nè«‹è¼¸å…¥å¯¦éš›é‡‘é¡ï¼š`, term.expAmt); if (actualAmt === null) return;
                    const actualDate = prompt("å…¥å¸³æ—¥æœŸï¼š", new Date().toISOString().split('T')[0]); if (actualDate === null) return;
                    loading.value = true;
                    try {
                        await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'income', id: term.id, projectId: term.projectId, termName: term.termName, expectedDate: term.expDate, expectedAmount: term.expAmt, actualDate: actualDate, actualAmount: actualAmt, status: 'received' }), headers: {'Content-Type': 'text/plain'} });
                        alert('ğŸ’° æ”¶æ¬¾ç¢ºèªï¼'); await loadData();
                    } catch (e) { alert('å¤±æ•—'); } finally { loading.value = false; }
                };

                return { 
                    currentTab, loading, projects, users, projectStats, 
                    form, transferForm, incomeForm, batchForm, incomeMode, newProjectName, incomeProjectId, totalAmount, 
                    addItem, removeItem, submitForm, submitTransfer, submitIncome, submitCreateProject, submitBatchIncome, receiveMoney, calcPercent 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>