<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TranStation OS v15</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@400;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            /* ğŸ¨ æ ¸å¿ƒè‰²ç¥¨ï¼šå–è‡ªæ‚¨çš„ LOGO èˆ‡ã€Œå¥½å‘³å°å§/åœçˆã€æ¦‚å¿µ */
            --ts-blue: #1C4CA0; /* è½‰é§…è— */
            --ts-beige: #E6E1D8; /* æ› é‡ç±³ç° */
            --ts-paper: #F2F0EB; /* è³ªæ„Ÿç´™ç™½ */
            --ts-orange: #FF7043; /* åœçˆæš–æ©˜ */
            --ts-ink: #2B3A42;    /* å¢¨è‰²æ–‡å­— */
            --ts-green: #599E5E;  /* å±±æ—ç¶  */
            
            --shadow-card: 0 4px 20px -2px rgba(28, 76, 160, 0.08);
            --shadow-float: 0 10px 40px -10px rgba(28, 76, 160, 0.15);
        }

        /* ğŸ“œ ç´™è³ªè§¸æ„ŸèƒŒæ™¯ï¼šæ¶ˆé™¤ AI å¡‘è† æ„Ÿ */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--ts-beige);
            color: var(--ts-ink);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* ğŸ”ï¸ å¹¾ä½•å±±ä¸˜ï¼šå‘¼æ‡‰ LOGO çš„åœ“å¼§æ„Ÿ */
        .brand-bg {
            position: fixed; top: -10vh; right: -10vw; width: 80vw; height: 80vw;
            background: radial-gradient(circle, rgba(28,76,160,0.08) 0%, rgba(230,225,216,0) 70%);
            border-radius: 50%; z-index: -1; pointer-events: none;
        }
        .hills-bg {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 35vh;
            background: var(--ts-blue);
            mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 1440 320' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23000' fill-opacity='1' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 1440 320' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23000' fill-opacity='1' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            mask-size: cover; z-index: -1; opacity: 0.9;
        }

        /* ğŸ’ ç£¨ç ‚å¡ç‰‡ (Matte Glass) */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: var(--shadow-card);
            border-radius: 32px; /* æ›´åœ“æ½¤ï¼ŒåƒéµåµçŸ³ */
        }

        /* ğŸ“ Luke W é¢¨æ ¼è¡¨å–®ï¼šå¤§è§¸æ§å€ã€æ¸…æ™° */
        .warm-input {
            background: #FFFFFF;
            border: 2px solid transparent;
            border-radius: 16px; padding: 14px 16px;
            color: var(--ts-ink); font-weight: 700; font-size: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .warm-input:focus {
            outline: none; border-color: var(--ts-blue);
            box-shadow: 0 4px 12px rgba(28, 76, 160, 0.15);
            transform: translateY(-1px);
        }
        .warm-input-sm { padding: 8px 12px; font-size: 0.9rem; border-radius: 12px; background: #fff; border: 1px solid #eee; }

        /* ğŸŸ  åœçˆæŒ‰éˆ• */
        .btn-action {
            background: var(--ts-orange);
            color: white; border-radius: 20px; font-weight: 700;
            box-shadow: 0 8px 20px rgba(255, 112, 67, 0.25);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative; overflow: hidden;
        }
        .btn-action:active { transform: scale(0.96); box-shadow: 0 4px 10px rgba(255, 112, 67, 0.2); }
        .btn-action::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
            opacity: 0; transition: opacity 0.2s;
        }
        .btn-action:hover::after { opacity: 1; }

        /* ğŸ§­ å°èˆªè† å›Š */
        .nav-pill {
            padding: 12px 0; border-radius: 18px; color: #94A3B8;
            font-size: 0.95rem; font-weight: 600; transition: all 0.3s;
        }
        .nav-pill.active {
            background: #FFFFFF; color: var(--ts-blue);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }

        /* ğŸ’§ æ²¹é‡è¡¨ (Budget Bar) */
        .liquid-track { background: #E2E8F0; border-radius: 99px; overflow: hidden; }
        .liquid-bar {
            height: 100%; border-radius: 99px;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }
        /* è³ªæ„Ÿå…‰æ¾¤ */
        .liquid-bar::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.3) 0%, transparent 100%);
        }

        .loading-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(230, 225, 216, 0.95); backdrop-filter: blur(15px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .modal-mask {
            position: fixed; inset: 0; z-index: 60;
            background: rgba(28, 76, 160, 0.15); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center; padding: 1.5rem;
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .custom-scrollbar::-webkit-scrollbar { display: none; }
        .font-display { font-family: 'DM Serif Display', serif; } /* æ›´æœ‰é›œèªŒæ„Ÿçš„æ¨™é¡Œå­—é«” */
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .budget-pill { font-size: 10px; padding: 4px 8px; border-radius: 6px; background: #EEF2FF; color: var(--ts-blue); font-weight: 700; letter-spacing: 0.05em; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6 pb-24">

    <div class="brand-bg"></div>
    <div class="hills-bg"></div>

    <div id="app" class="w-full max-w-xl relative z-10">
        
        <div v-if="isSubmitting" class="loading-overlay">
            <div class="text-4xl mb-4 animate-bounce">â›º</div>
            <div class="text-lg font-bold tracking-widest text-[#1C4CA0] font-mono">SYNCING...</div>
        </div>

        <div v-if="!loading && !currentUser && !isSubmitting" class="modal-mask">
            <div class="glass-panel p-8 w-full max-w-xs text-center border border-white">
                <h3 class="text-3xl font-display text-[#1C4CA0] mb-2">TranStation</h3>
                <p class="text-xs text-stone-500 mb-8 font-bold tracking-widest uppercase">Creative Research Lab</p>
                <select v-model="tempUser" class="warm-input w-full mb-4 text-center text-lg bg-stone-50">
                    <option disabled value="">- é¸æ“‡å¤¥ä¼´ -</option>
                    <option v-for="u in users" :key="u.id" :value="u">{{ u.name }}</option>
                </select>
                <button @click="confirmIdentity" :disabled="!tempUser" class="w-full btn-action py-4 text-lg">é€²å…¥æ› é‡</button>
            </div>
        </div>

        <div class="flex justify-between items-end mb-8 px-2">
            <div>
                <div class="flex items-center gap-2 mb-1 opacity-70">
                    <span class="w-2 h-2 rounded-full bg-[#FF7043]"></span>
                    <h1 class="text-[10px] tracking-[0.2em] text-[#1C4CA0] font-bold">TRANSTATION OS</h1>
                </div>
                <h2 class="text-4xl font-display text-[#2B3A42]">è½‰é§…å‰µç ” é ç®—è¨˜å¸³ç®¡ç†ç³»çµ± <span class="text-[#FF7043] text-2xl font-mono align-top opacity-80">v15</span></h2>
            </div>
            <div class="flex items-center gap-3">
                 <div class="text-[10px] font-mono font-bold text-stone-500 bg-white/50 px-3 py-1.5 rounded-full border border-white backdrop-blur-sm">
                     SYNC <span :class="autoRefreshTimer < 10 ? 'text-[#FF7043]' : 'text-[#1C4CA0]'">{{ autoRefreshTimer }}</span>s
                 </div>
                 <button @click="forceRefresh" class="bg-white/50 hover:bg-white w-10 h-10 rounded-full text-[#1C4CA0] shadow-sm flex items-center justify-center transition-all">â†»</button>
                 <div v-if="currentUser" class="text-sm font-bold text-white bg-[#1C4CA0] w-10 h-10 rounded-full shadow-lg flex items-center justify-center border-2 border-white/30">
                    {{ currentUser.name.charAt(0) }}
                </div>
            </div>
        </div>

        <div class="glass-panel p-6 min-h-[680px] flex flex-col gap-6">

            <div class="grid grid-cols-3 gap-3">
                <div class="bg-white/60 p-4 rounded-[24px] border border-white text-center flex flex-col justify-center shadow-sm">
                    <div class="text-[10px] text-stone-400 font-bold mb-1 tracking-wider uppercase">Revenue</div>
                    <div class="text-sm sm:text-lg font-mono font-bold text-[#1C4CA0]">${{ formatCompact(globalStats.revenue) }}</div>
                </div>
                <div class="bg-white/60 p-4 rounded-[24px] border border-white text-center flex flex-col justify-center shadow-sm">
                    <div class="text-[10px] text-stone-400 font-bold mb-1 tracking-wider uppercase">Cash</div>
                    <div class="text-sm sm:text-lg font-mono font-bold text-[#599E5E]">${{ formatCompact(globalStats.cash) }}</div>
                </div>
                <div class="bg-white/60 p-4 rounded-[24px] border border-white text-center flex flex-col justify-center relative overflow-hidden shadow-sm">
                    <div v-if="globalStats.debt > 0" class="absolute inset-0 bg-[#FF7043]/5"></div>
                    <div class="text-[10px] text-stone-400 font-bold mb-1 tracking-wider uppercase">Pending</div>
                    <div class="text-sm sm:text-lg font-mono font-bold" :class="globalStats.debt > 0 ? 'text-[#FF7043]' : 'text-stone-300'">
                        ${{ formatCompact(globalStats.debt) }}
                    </div>
                </div>
            </div>

            <div class="flex bg-[#E6E1D8]/50 p-1.5 rounded-[24px]">
                <button @click="tab='dashboard'" :class="{active: tab==='dashboard'}" class="nav-pill flex-1 text-center">å°ˆæ¡ˆæ¦‚æ³</button>
                <button @click="tab='funds'" :class="{active: tab==='funds'}" class="nav-pill flex-1 text-center">è³‡é‡‘æ°´ä½</button>
                <button @click="tab='expense'" :class="{active: tab==='expense'}" class="nav-pill flex-1 text-center">æ”¯å‡ºè¨˜å¸³</button>
                <button @click="tab='income'" :class="{active: tab==='income'}" class="nav-pill flex-1 text-center">é€²å¸³ç®¡ç†</button>
            </div>

            <div v-if="tab==='dashboard'" class="flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-1">
                <div v-for="(stat, pid) in projectStats" :key="pid" @click="openProjectDetail(stat, pid)" 
                     class="bg-white hover:bg-[#F8FAFC] p-5 rounded-[28px] border border-[#F1F5F9] shadow-sm cursor-pointer transition-all hover:-translate-y-1 relative group overflow-hidden">
                    
                    <div class="flex justify-between items-start mb-4 relative z-10">
                        <div>
                            <h3 class="font-bold text-lg text-[#2B3A42] leading-tight mb-1">{{ stat.name }}</h3>
                            <span class="text-[10px] bg-[#EEF2FF] text-[#1C4CA0] px-2 py-0.5 rounded-md font-bold">Ret. {{ stat.retentionRate }}%</span>
                        </div>
                        <div class="text-right">
                            <div class="text-[9px] text-stone-400 tracking-widest uppercase font-bold">Safe Budget</div>
                            <div class="text-xl font-mono font-bold tracking-tight" :class="stat.safeBalance >= 0 ? 'text-[#1C4CA0]' : 'text-[#FF7043]'">
                                ${{ formatCompact(stat.safeBalance) }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="h-2 w-full bg-[#E2E8F0] rounded-full overflow-hidden mb-4">
                        <div class="h-full bg-[#1C4CA0]" :style="{width: Math.min((stat.totalExpense/stat.safeBudget)*100, 100) + '%'}"></div>
                    </div>

                    <div class="flex justify-between items-center pt-3 border-t border-stone-100 relative z-10">
                        <div class="text-[11px] text-stone-500 font-bold">ç¾é‡‘æµç‹€æ³</div>
                        <div class="text-sm font-mono font-bold" :class="stat.cashBalance < 0 ? 'text-[#FF7043]' : 'text-[#599E5E]'">
                            {{ stat.cashBalance < 0 ? '-' : '+' }}${{ formatCompact(Math.abs(stat.cashBalance)) }}
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="tab==='funds'" class="flex-1 flex flex-col space-y-4 animate-[fadeIn_0.3s_ease-out]">
                <div class="bg-white/50 rounded-[32px] p-6 border border-white shadow-sm relative overflow-hidden flex-1">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-bold text-[#1C4CA0] flex items-center gap-2">
                            <span class="bg-[#EEF2FF] w-6 h-6 flex items-center justify-center rounded-full text-xs">ğŸ’§</span> 
                            äººå“¡è³‡é‡‘æ°´ä½
                        </h3>
                        <button @click="showTransferModal=true" class="bg-white text-[#1C4CA0] px-4 py-2 text-xs font-bold rounded-full shadow-sm border border-[#EEF2FF] hover:bg-[#EEF2FF] transition-colors">+ æ’¥è£œ/è½‰å¸³</button>
                    </div>
                    <div class="space-y-6 overflow-y-auto custom-scrollbar h-[380px] px-1">
                        <div v-for="u in userStatusList" :key="u.id" @click="openUserHistory(u)" class="cursor-pointer group">
                            <div class="flex justify-between text-[11px] font-bold text-stone-600 mb-2 px-1 font-mono">
                                <span :class="{'opacity-0': u.balance >= 0}" class="text-[#FF7043]">${{ formatCompact(Math.abs(u.balance)) }}</span>
                                <span class="group-hover:text-[#FF7043] transition-colors bg-white/80 px-3 py-0.5 rounded-full shadow-sm">{{ u.name }}</span>
                                <span :class="{'opacity-0': u.balance <= 0}" class="text-[#599E5E]">${{ formatCompact(u.balance) }}</span>
                            </div>
                            <div class="relative h-4 liquid-track w-full flex items-center bg-white">
                                <div class="absolute left-1/2 top-0 bottom-0 w-[2px] bg-stone-200 z-10 h-full"></div>
                                <div class="w-1/2 h-full flex justify-end pr-[1px]">
                                    <div v-if="u.balance < 0" class="liquid-bar bg-[#FF7043]" :style="{width: Math.min((Math.abs(u.balance)/maxUserBalance)*100, 100) + '%'}"></div>
                                </div>
                                <div class="w-1/2 h-full flex justify-start pl-[1px]">
                                    <div v-if="u.balance > 0" class="liquid-bar bg-[#599E5E]" :style="{width: Math.min((u.balance/maxUserBalance)*100, 100) + '%'}"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="tab==='expense'" class="flex-1 flex flex-col animate-[fadeIn_0.3s_ease-out]">
                <div class="bg-white/50 p-6 rounded-[32px] shadow-sm border border-white flex-1 flex flex-col">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                         <div class="group">
                            <label class="text-[10px] text-stone-400 font-bold pl-1 mb-1 block uppercase tracking-wider">Date</label>
                            <input type="date" v-model="form.date" class="warm-input w-full font-mono text-sm">
                         </div>
                         <div class="group">
                            <label class="text-[10px] text-stone-400 font-bold pl-1 mb-1 block uppercase tracking-wider">Payer</label>
                            <select v-model="form.payer" class="warm-input w-full text-sm font-bold text-[#1C4CA0]">
                                <option v-for="u in users" :value="u.name">{{ u.name }}</option>
                            </select>
                         </div>
                    </div>
                    <div class="space-y-3 mb-6 flex-1 overflow-y-auto custom-scrollbar px-1">
                        <div v-for="(item, idx) in form.items" :key="idx" class="bg-white p-4 rounded-[20px] relative shadow-[0_2px_10px_rgba(0,0,0,0.03)] border border-stone-100">
                            <button v-if="form.items.length>1" @click="form.items.splice(idx,1)" class="absolute -right-2 -top-2 bg-[#FF7043] text-white w-6 h-6 rounded-full flex items-center justify-center shadow-md text-xs font-bold hover:scale-110 transition-transform">Ã—</button>
                            
                            <div class="flex gap-3 mb-3">
                                <select v-model="item.projectId" class="warm-input flex-[2] text-sm py-2 h-12 bg-stone-50 border-stone-100">
                                    <option disabled value="">é¸æ“‡å°ˆæ¡ˆ...</option>
                                    <option v-for="p in projects" :value="p.id">{{ p.name }}</option>
                                </select>
                                <input type="number" v-model.number="item.amount" placeholder="$" class="warm-input flex-1 text-lg text-right font-mono h-12 text-[#1C4CA0]">
                            </div>

                            <div v-if="item.projectId && getProjectBudgetLines(item.projectId).length > 0" class="mb-3 animate-[fadeIn_0.2s]">
                                <select v-model="item.category" class="w-full bg-[#EEF2FF] border-none rounded-xl text-xs py-2 px-3 text-[#1C4CA0] font-bold outline-none cursor-pointer hover:bg-blue-100 transition-colors">
                                    <option value="">- æ­¸å±¬é ç®—ç§‘ç›® -</option>
                                    <option v-for="line in getProjectBudgetLines(item.projectId)" :value="line.category">
                                        {{ line.category }} (é¤˜ ${{ (line.budget - line.used).toLocaleString() }})
                                    </option>
                                </select>
                            </div>

                            <input type="text" v-model="item.itemName" placeholder="å“é …èªªæ˜ (å¦‚: é«˜éµç¥¨)" class="warm-input w-full text-sm bg-transparent border-dashed border-stone-200">
                        </div>
                        <button @click="form.items.push({projectId:'',amount:'',itemName:'',category:''})" class="w-full py-3 border-2 border-dashed border-stone-300 text-stone-400 rounded-xl text-xs font-bold hover:border-[#1C4CA0] hover:text-[#1C4CA0] transition-colors tracking-widest">+ å¢åŠ æ˜ç´°</button>
                    </div>
                    <button @click="submitExpense" class="w-full btn-action py-4 text-sm tracking-[0.2em] shadow-xl flex items-center justify-center gap-2">
                        <span>ç¢ºèªæ”¯å‡º</span>
                        <span class="font-mono bg-white/20 px-2 rounded text-xs">${{ totalExpense.toLocaleString() }}</span>
                    </button>
                </div>
            </div>

            <div v-if="tab==='income'" class="flex-1 space-y-4">
                <div class="bg-white/60 p-6 rounded-[32px] shadow-sm border border-white space-y-5">
                    <h3 class="text-sm font-bold text-[#1C4CA0] border-b border-stone-200/50 pb-3 flex items-center gap-2">
                        <span class="text-lg">ğŸŒ±</span> å•Ÿå‹•æ–°å°ˆæ¡ˆ
                    </h3>
                    <div class="flex gap-3">
                        <input type="text" v-model="newProj.name" placeholder="å°ˆæ¡ˆåç¨±" class="warm-input flex-[2] text-sm">
                        <input type="number" v-model.number="newProj.retention" placeholder="æŠ½æˆ%" class="warm-input flex-1 text-sm text-center font-bold text-[#FF7043] bg-[#FFF5F2]">
                    </div>
                    <div class="flex gap-3">
                        <input type="number" v-model.number="newProj.budget" placeholder="ç¸½é ç®—" class="warm-input flex-[2] text-sm font-mono">
                        <button @click="createProject" class="flex-1 btn-action text-xs font-bold shadow-lg">å»ºç«‹</button>
                    </div>
                </div>
                <div class="text-center text-stone-400 text-[10px] mt-4 font-bold tracking-wider">è¦ç™»è¨˜åˆ†æœŸæ¬¾ï¼Œè«‹è‡³ã€Œå°ˆæ¡ˆæ¦‚æ³ã€é»æ“Šå¡ç‰‡</div>
            </div>
        </div>

        <div v-if="showTransferModal" class="modal-mask" @click.self="showTransferModal=false">
            <div class="glass-panel p-8 w-full max-w-sm bg-white border border-stone-100">
                <h3 class="text-xl font-bold text-[#1C4CA0] mb-6 flex items-center gap-2"><span class="bg-[#EEF2FF] p-2 rounded-lg text-lg">ğŸ’¸</span> æ’¥è£œ / è½‰å¸³</h3>
                <div class="space-y-4">
                    <select v-model="transferForm.projectId" class="warm-input w-full text-sm">
                        <option disabled value="">è³‡é‡‘ä¾†æºå°ˆæ¡ˆ...</option>
                        <option v-for="p in projects" :value="p.id">{{ p.name }}</option>
                    </select>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <select v-model="transferForm.targetUser" class="warm-input w-full text-sm font-bold text-[#FF7043]">
                                <option disabled value="">å°è±¡...</option>
                                <option v-for="u in users" :value="u.name">{{ u.name }}</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <input type="number" v-model.number="transferForm.amount" placeholder="$" class="warm-input w-full text-lg font-mono text-[#1C4CA0]">
                        </div>
                    </div>
                    <input type="text" v-model="transferForm.note" placeholder="å‚™è¨»" class="warm-input w-full text-sm">
                    <button @click="submitTransfer" class="w-full bg-[#599E5E] text-white py-4 rounded-2xl font-bold shadow-lg mt-2">ç¢ºèªæ’¥æ¬¾</button>
                </div>
            </div>
        </div>

        <div v-if="selectedProject" class="modal-mask" @click.self="selectedProject=null">
            <div class="glass-panel p-6 w-full max-w-sm bg-white h-[85vh] flex flex-col relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-[#1C4CA0]/5 to-transparent z-0"></div>
                <div class="flex justify-between items-start mb-6 relative z-10">
                    <div>
                        <h2 class="text-2xl font-display font-bold text-[#1C4CA0]">{{ selectedProject.name }}</h2>
                        <div class="text-[10px] text-stone-500 font-mono mt-1 font-bold">ID: {{ selectedProject.id }}</div>
                    </div>
                    <button @click="selectedProject=null" class="bg-white w-8 h-8 rounded-full shadow text-stone-500 font-bold hover:text-[#FF7043]">Ã—</button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar space-y-6 relative z-10 pr-2">
                    
                    <div>
                        <h4 class="text-xs font-bold text-stone-400 tracking-widest mb-3 uppercase flex justify-between items-center">
                            Budget Details
                            <button @click="showAddBudgetLine=!showAddBudgetLine" class="text-[#1C4CA0] bg-[#EEF2FF] px-2 py-0.5 rounded text-[10px] font-bold hover:bg-blue-100 transition-colors">+ ç§‘ç›®</button>
                        </h4>
                        
                        <div v-if="showAddBudgetLine" class="mb-3 bg-stone-50 p-2 rounded-lg flex gap-1 animate-[fadeIn_0.2s_ease-out]">
                            <input type="text" v-model="newBudget.category" placeholder="ç§‘ç›®" class="warm-input-sm w-1/3">
                            <input type="number" v-model.number="newBudget.amount" placeholder="$" class="warm-input-sm flex-1">
                            <button @click="addBudgetLine" class="bg-[#1C4CA0] text-white rounded px-2 text-xs font-bold">OK</button>
                        </div>

                        <div class="space-y-3">
                            <div v-for="line in selectedProject.budgetLines" :key="line.category" class="bg-white p-4 rounded-2xl border border-stone-100 shadow-[0_2px_8px_rgba(0,0,0,0.02)] text-xs">
                                <div class="flex justify-between mb-2">
                                    <span class="font-bold text-stone-700 flex items-center gap-2">
                                        {{ line.category }}
                                        <span v-if="line.used > line.budget" class="text-[9px] bg-[#FF7043] text-white px-1.5 py-0.5 rounded font-bold">å·²è¶…æ”¯</span>
                                    </span>
                                    <span class="font-mono text-[10px]" :class="(line.budget - line.used) < 0 ? 'text-[#FF7043] font-bold' : 'text-stone-400'">
                                        é¤˜ ${{ (line.budget - line.used).toLocaleString() }} <span class="text-stone-300">/ ${{ line.budget.toLocaleString() }}</span>
                                    </span>
                                </div>
                                
                                <div class="h-2 w-full bg-[#F1F5F9] rounded-full overflow-hidden relative">
                                    <div class="h-full transition-all duration-700 ease-out rounded-full relative"
                                         :class="(line.budget - line.used) < 0 ? 'bg-[#FF7043] w-full animate-pulse' : ((line.budget - line.used)/line.budget < 0.2 ? 'bg-[#FF7043]' : 'bg-[#1C4CA0]')"
                                         :style="{width: Math.max(((line.budget - line.used)/line.budget)*100, 0) + '%'}">
                                         <div class="absolute top-0 right-0 bottom-0 left-0 bg-gradient-to-b from-white/30 to-transparent"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div v-if="!selectedProject.budgetLines.length" class="text-center text-[10px] text-stone-300 py-6 border-2 border-dashed border-stone-100 rounded-2xl cursor-pointer hover:border-[#1C4CA0] hover:text-[#1C4CA0] transition-colors" @click="showAddBudgetLine=!showAddBudgetLine">
                                å°šæœªè¨­å®šé ç®—ç´°é …ï¼Œé»æ“Šæ­¤è™•æ–°å¢
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-bold text-stone-400 tracking-widest mb-3 uppercase">Income Timeline</h4>
                        <div class="space-y-3 pl-2 border-l-2 border-stone-100 ml-2">
                             <div v-for="term in selectedProject.incomeTerms" :key="term.id" class="relative pl-6">
                                 <div class="absolute -left-[5px] top-2 w-2.5 h-2.5 rounded-full border-2 border-white shadow-sm" :class="term.status==='received' ? 'bg-[#599E5E]' : 'bg-stone-300'"></div>
                                 <div class="bg-white p-3 rounded-xl border border-stone-100 shadow-sm flex justify-between items-center hover:shadow-md transition-shadow">
                                     <div>
                                         <div class="text-xs font-bold text-stone-700">{{ term.termName }}</div>
                                         <div class="text-[10px] font-mono text-stone-400">${{ term.amount.toLocaleString() }}</div>
                                     </div>
                                     <button v-if="term.status==='pending'" @click="confirmIncome(term)" class="text-[10px] bg-[#1C4CA0] text-white px-3 py-1.5 rounded-lg shadow-sm font-bold hover:scale-105 transition-transform">å…¥å¸³</button>
                                     <div v-else class="text-[10px] font-bold text-[#599E5E] bg-green-50 px-2 py-1 rounded border border-green-100">RECEIVED</div>
                                 </div>
                             </div>
                             <div class="relative pl-6 mt-4">
                                <div class="absolute -left-[3px] top-3 w-1.5 h-1.5 rounded-full bg-stone-200"></div>
                                <div class="flex gap-2">
                                    <input type="text" v-model="newTerm.name" placeholder="åç¨±" class="warm-input-sm w-20">
                                    <input type="number" v-model.number="newTerm.amount" placeholder="$" class="warm-input-sm flex-1 font-mono">
                                    <button @click="addTerm" class="bg-stone-200 text-stone-600 px-3 rounded-xl text-lg font-bold hover:bg-stone-300 transition-colors">+</button>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="selectedUser" class="modal-mask" @click.self="selectedUser=null">
             <div class="glass-panel p-6 w-full max-w-sm bg-white h-[80vh] flex flex-col">
                <div class="border-b border-stone-100 pb-4 mb-4 flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-stone-800 font-display">{{ selectedUser.name }}</h3>
                        <p class="text-xs text-stone-400 mt-1 font-bold">äº¤æ˜“ç´€éŒ„</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-mono font-bold" :class="selectedUser.balance<0?'text-[#FF7043]':'text-[#599E5E]'">
                            ${{ formatCompact(selectedUser.balance) }}
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                    <div v-for="tx in getUserHistory(selectedUser.name)" :key="tx.id" class="p-3 rounded-2xl border border-transparent bg-stone-50 hover:bg-white hover:shadow-sm hover:border-stone-100 transition-all">
                        <div v-if="editingTx !== tx.id" class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-xs text-stone-600 flex items-center gap-1">
                                    {{ tx.item || tx.note || 'æ’¥æ¬¾' }}
                                    <span v-if="tx.category" class="budget-pill">{{ tx.category }}</span>
                                </div>
                                <div class="text-[9px] text-stone-400 mt-0.5">{{ tx.date }} Â· {{ tx.project }}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-mono font-bold text-xs" :class="tx.isIncome ? 'text-[#599E5E]' : 'text-[#FF7043]'">{{ tx.isIncome ? '+' : '-' }}${{ tx.amount.toLocaleString() }}</span>
                                <button v-if="!tx.isIncome" @click="startEdit(tx)" class="text-stone-300 hover:text-[#1C4CA0] p-1">âœ</button>
                                <button @click="deleteTransaction(tx)" class="text-stone-300 hover:text-red-500 p-1">âœ•</button>
                            </div>
                        </div>
                        <div v-else class="bg-white p-2 rounded-xl border border-[#1C4CA0] space-y-2">
                            <div class="flex gap-1">
                                <input type="date" v-model="editForm.date" class="warm-input-sm w-full">
                                <input type="number" v-model.number="editForm.amount" class="warm-input-sm w-full font-mono text-right text-[#1C4CA0] font-bold">
                            </div>
                            <input type="text" v-model="editForm.item" placeholder="å“é …" class="warm-input-sm w-full">
                            <input type="text" v-model="editForm.note" placeholder="å‚™è¨»" class="warm-input-sm w-full">
                            <select v-if="tx.projectId" v-model="editForm.category" class="warm-input-sm w-full">
                                <option value="">(ç„¡ç§‘ç›®)</option>
                                <option v-for="line in getProjectBudgetLines(tx.projectId)" :value="line.category">{{ line.category }}</option>
                            </select>
                            <div class="flex gap-2 mt-2">
                                <button @click="cancelEdit" class="flex-1 bg-stone-100 text-stone-500 rounded-lg text-xs py-2 font-bold">å–æ¶ˆ</button>
                                <button @click="saveEdit(tx)" class="flex-1 bg-[#1C4CA0] text-white rounded-lg text-xs py-2 font-bold">å„²å­˜</button>
                            </div>
                        </div>
                    </div>
                </div>
             </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyKtICKtLnl01vytLz90174UICy1bfdMbKQdRqeZX3KOhyQGwJNQyXQDouxnXXfEfLQ/exec'; 

        createApp({
            setup() {
                const currentUser = ref(null);
                const tempUser = ref(null);
                const loading = ref(false);
                const isSubmitting = ref(false);
                const tab = ref('dashboard');
                const autoRefreshTimer = ref(30);
                
                const users = ref([]);
                const projects = ref([]);
                const projectStats = ref({});
                const allTransactions = ref([]); 
                
                const form = ref({ date: new Date().toISOString().split('T')[0], payer: '', items: [{projectId:'',amount:'',itemName:'',category:''}] });
                const transferForm = ref({ projectId: '', targetUser: '', amount: '', note: '' });
                const newProj = ref({ name: '', budget: '', retention: 10 });
                const newTerm = ref({ name: '', amount: '' });
                
                const showAddBudgetLine = ref(false);
                const newBudget = ref({ category: '', amount: '' });
                const editingTx = ref(null);
                const editForm = ref({});
                
                const showTransferModal = ref(false);
                const selectedUser = ref(null);
                const selectedProject = ref(null);

                onMounted(() => {
                    loadData();
                    setInterval(() => {
                        if (autoRefreshTimer.value > 0) autoRefreshTimer.value--;
                        else { loadData(true); autoRefreshTimer.value = 30; }
                    }, 1000);
                });

                const forceRefresh = () => { loadData(); autoRefreshTimer.value = 30; };

                const loadData = async (silent = false) => {
                    if(!silent) loading.value = true;
                    try {
                        const res = await fetch(`${GAS_API_URL}?op=getData`);
                        const data = await res.json();
                        users.value = data.users;
                        projects.value = data.projects;
                        projectStats.value = data.projectStats;
                        allTransactions.value = data.allTransactions;
                        
                        if(currentUser.value) currentUser.value = users.value.find(x => x.name === currentUser.value.name) || currentUser.value;
                        if(selectedProject.value) selectedProject.value = { ...projectStats.value[selectedProject.value.id], id: selectedProject.value.id };
                        if(selectedUser.value) selectedUser.value = users.value.find(u => u.name === selectedUser.value.name) || selectedUser.value;

                    } catch(e) { console.error(e); }
                    if(!silent) loading.value = false;
                };

                const apiCall = async (payload) => {
                    isSubmitting.value = true;
                    try {
                        await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({...payload, operator: currentUser.value?.name}), headers: {'Content-Type': 'text/plain'} });
                        await loadData();
                        return true;
                    } catch(e) { alert('Error'); return false; } 
                    finally { setTimeout(() => isSubmitting.value = false, 500); }
                };

                const globalStats = computed(() => {
                    let revenue = 0, cash = 0, debt = 0;
                    Object.values(projectStats.value).forEach(p => {
                        p.incomeTerms.forEach(term => { if(term.status === 'received') revenue += term.amount; });
                        cash += p.cashBalance;
                    });
                    users.value.forEach(u => { if(u.pettyCash < 0) debt += Math.abs(u.pettyCash); });
                    return { revenue, cash, debt };
                });

                const totalExpense = computed(() => form.value.items.reduce((s,i)=>s+(Number(i.amount)||0),0));
                const userStatusList = computed(() => users.value.map(u => ({...u, balance: u.pettyCash})));
                const maxUserBalance = computed(() => { const max = Math.max(...users.value.map(u => Math.abs(u.pettyCash))); return max === 0 ? 1000 : max; });

                const confirmIdentity = () => { currentUser.value = tempUser.value; form.value.payer = currentUser.value.name; };
                const formatCompact = (n) => new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(n);

                const submitExpense = async () => {
                    const items = form.value.items.map(i => ({...i, projectName: projects.value.find(p=>p.id===i.projectId)?.name}));
                    if(await apiCall({ action: 'expense', date: form.value.date, payer: form.value.payer, items })) {
                        form.value.items = [{projectId:'',amount:'',itemName:'',category:''}];
                    }
                };
                
                const addBudgetLine = async () => {
                    if(!newBudget.value.category || !newBudget.value.amount) return;
                    await apiCall({ action: 'addBudgetLine', projectId: selectedProject.value.id, ...newBudget.value });
                    newBudget.value = { category: '', amount: '' }; showAddBudgetLine.value = false;
                };

                const getProjectBudgetLines = (pid) => { return projectStats.value[pid]?.budgetLines || []; };
                const startEdit = (tx) => { editingTx.value = tx.id; editForm.value = { ...tx }; };
                const cancelEdit = () => { editingTx.value = null; editForm.value = {}; };
                const saveEdit = async (originalTx) => { if(await apiCall({ action: 'editTransaction', ...editForm.value })) { editingTx.value = null; } };
                const deleteTransaction = async (tx) => { if(confirm(`ç¢ºå®šåˆªé™¤ ${tx.item || 'æ­¤ç­†ç´€éŒ„'} $${tx.amount}?`)) await apiCall({ action: 'deleteTransaction', id: tx.id, type: tx.type }); };
                const submitTransfer = async () => { const pName = projects.value.find(p=>p.id===transferForm.value.projectId)?.name; if(await apiCall({ action: 'transfer', ...transferForm.value, projectName: pName })) { showTransferModal.value = false; transferForm.value = { projectId: '', targetUser: '', amount: '', note: '' }; } };
                const createProject = async () => { if(await apiCall({ action: 'createProject', ...newProj.value })) { newProj.value = { name: '', budget: '', retention: 10 }; alert('âœ¨ å°ˆæ¡ˆå·²å»ºç«‹'); } };
                const addTerm = async () => { if(!selectedProject.value || !newTerm.value.amount) return; await apiCall({ action: 'addTerm', projectId: selectedProject.value.id, ...newTerm.value }); newTerm.value = { name: '', amount: '' }; };
                const confirmIncome = async (term) => { if(confirm(`ç¢ºèªæ”¶åˆ°æ¬¾é … $${term.amount}?`)) await apiCall({ action: 'confirmIncome', id: term.id }); };
                
                const openUserHistory = (u) => selectedUser.value = u;
                const getUserHistory = (name) => allTransactions.value.filter(tx => tx.relatedUser === name).sort((a,b)=>new Date(b.date)-new Date(a.date));
                const openProjectDetail = (stat, pid) => selectedProject.value = { id: pid, ...stat };

                return {
                    currentUser, tempUser, loading, isSubmitting, tab, autoRefreshTimer,
                    users, projects, projectStats, userStatusList, maxUserBalance, globalStats,
                    form, transferForm, newProj, newTerm, totalExpense,
                    showTransferModal, selectedUser, selectedProject,
                    showAddBudgetLine, newBudget, editingTx, editForm,
                    confirmIdentity, formatCompact, submitExpense, submitTransfer, createProject,
                    openUserHistory, getUserHistory, openProjectDetail,
                    addTerm, confirmIncome, deleteTransaction, loadData, forceRefresh,
                    addBudgetLine, getProjectBudgetLines, startEdit, cancelEdit, saveEdit
                };
            }
        }).mount('#app');
    </script>
</body>
</html>