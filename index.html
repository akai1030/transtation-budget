<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è½‰é§…å‰µç ” | é ç®—å¸³å‹™ç³»çµ±</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,700;1,500&family=Plus+Jakarta+Sans:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            /* ğŸ¨ é…è‰²éˆæ„Ÿï¼šå¥½å‘³å°å§ (æº«æš–ç±³è‰²) + Headspace (æ´»åŠ›æ©˜) */
            --c-bg: #F9F7F5;          /* é›²éœ§ç±³ç™½ */
            --c-glass: rgba(255, 255, 255, 0.65); /* äº®è‰²ç£¨ç ‚ç»ç’ƒ */
            --c-glass-border: rgba(255, 255, 255, 0.8);
            --c-text-main: #334155;   /* æ·±å²©ç° (ä»£æ›¿ç´”é»‘ï¼Œæ›´æœ‰è³ªæ„Ÿ) */
            --c-text-muted: #94A3B8;
            --c-orange: #FB923C;      /* æš–é™½æ©˜ (Headspace Orange) */
            --c-orange-dark: #EA580C;
            --c-green: #10B981;
            --c-red: #F43F5E;
        }

        /* ğŸ”ï¸ åŸºç¤è¨­å®š */
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--c-bg);
            color: var(--c-text-main);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
        }

        /* ğŸï¸ é›»å½±è† å·å™ªé» (Film Grain) - æ”¹ç‚ºæ·±è‰²å™ªé» */
        .film-grain {
            position: fixed; inset: 0; pointer-events: none; z-index: 9999;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            mix-blend-mode: multiply; /* åœ¨äº®è‰²èƒŒæ™¯ä¸Šç”¨ multiply */
            opacity: 0.3;
        }

        /* ğŸŒ… å‹•æ…‹èƒŒæ™¯ï¼šæµå‹•çš„æ™¨æ›¦ (Fluid Organic Shapes) */
        .ambient-light {
            position: fixed; border-radius: 50%; filter: blur(80px); z-index: -1;
            animation: drift 25s infinite alternate ease-in-out;
            mix-blend-mode: multiply; /* è®“é¡è‰²åƒæ°´å½©ä¸€æ¨£æšˆæŸ“ */
        }
        /* æš–é™½ */
        .light-1 { top: -10%; left: -10%; width: 90vw; height: 90vw; background: radial-gradient(circle, #FFedd5, transparent); opacity: 0.8; animation-duration: 30s; }
        /* è—å¤© */
        .light-2 { bottom: -20%; right: -20%; width: 100vw; height: 100vw; background: radial-gradient(circle, #E0F2FE, transparent); opacity: 0.7; animation-delay: -5s; }
        /* æ´»åŠ›å…‰æ–‘ */
        .light-3 { top: 40%; left: 30%; width: 50vw; height: 50vw; background: radial-gradient(circle, #FFDDC1, transparent); opacity: 0.6; animation: pulse 12s infinite alternate; }

        @keyframes drift { 0% { transform: translate(0,0) rotate(0deg); } 100% { transform: translate(-30px, 40px) rotate(10deg); } }
        @keyframes pulse { 0% { opacity: 0.5; transform: scale(1); } 100% { opacity: 0.8; transform: scale(1.15); } }

        /* ğŸ§Š äº®è‰²ç»ç’ƒæ“¬æ…‹ (Light Glassmorphism) */
        .glass-panel {
            background: linear-gradient(145deg, rgba(255,255,255,0.8), rgba(255,255,255,0.4));
            backdrop-filter: blur(40px) saturate(120%); -webkit-backdrop-filter: blur(40px) saturate(120%);
            border: 1px solid white;
            box-shadow: 
                0 20px 40px -10px rgba(189, 195, 215, 0.3), /* æŸ”å’Œçš„å½©è‰²é™°å½± */
                inset 0 0 0 1px rgba(255,255,255,0.5);
            border-radius: 32px;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
        }
        .glass-panel:hover {
            box-shadow: 0 30px 60px -15px rgba(251, 146, 60, 0.15); /* æ‡¸åœæ™‚æ³›èµ·æ©˜å…‰ */
        }
        .glass-panel:active { transform: scale(0.98); }

        /* ğŸ”¥ ç‡Ÿç«æŒ‰éˆ• (Campfire Button) - Headspace é¢¨æ ¼ */
        .btn-campfire {
            background: linear-gradient(135deg, #FB923C 0%, #EA580C 100%);
            color: white; border-radius: 24px; font-weight: 700; letter-spacing: 0.05em;
            box-shadow: 0 10px 25px -5px rgba(249, 115, 22, 0.4), inset 0 2px 0 rgba(255,255,255,0.2);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; overflow: hidden;
            border: none;
        }
        .btn-campfire:active { transform: scale(0.95); box-shadow: 0 5px 12px -5px rgba(249, 115, 22, 0.4); }
        /* æ°´æ³¢ç´‹æ•ˆæœ */
        .btn-campfire::after {
            content: ''; position: absolute; inset: 0; 
            background: radial-gradient(circle at center, rgba(255,255,255,0.4), transparent 70%);
            opacity: 0; transition: opacity 0.3s;
        }
        .btn-campfire:hover::after { opacity: 1; }

        /* ğŸ–Šï¸ ç„¡å°é¢¨è¼¸å…¥æ¡† (Muji Input) */
        .clean-input {
            background: rgba(255,255,255,0.5);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 20px; padding: 16px 20px;
            color: var(--c-text-main); font-size: 1rem; font-weight: 600;
            transition: all 0.3s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        .clean-input:focus {
            outline: none; background: #FFF;
            border-color: var(--c-orange);
            box-shadow: 0 0 0 4px rgba(251, 146, 60, 0.15);
        }
        .clean-input::placeholder { color: #94A3B8; font-weight: 400; }

        /* â›½ æ²¹é‡è¡¨ (Fuel) - æ›´åŠ åœ“æ½¤å¯æ„› */
        .fuel-track {
            background: rgba(0,0,0,0.05); border-radius: 99px; height: 10px; overflow: hidden; position: relative;
        }
        .fuel-bar {
            height: 100%; border-radius: 99px;
            background: linear-gradient(90deg, #FB923C, #FDBA74);
            box-shadow: 0 0 10px rgba(251, 146, 60, 0.3);
            transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
            position: relative;
        }

        /* ğŸï¸ æ‡¸æµ®å³¶å°èˆª (Floating Island) - Apple Dynamic Island é¢¨æ ¼ */
        .island-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 1);
            border-radius: 100px; padding: 6px;
            display: flex; justify-content: space-between;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1);
        }
        .nav-item {
            flex: 1; text-align: center; padding: 12px 0;
            color: #94A3B8; font-size: 0.85rem; font-weight: 700;
            border-radius: 99px; transition: all 0.3s; position: relative;
            z-index: 1;
        }
        .nav-item.active { color: #334155; }
        /* å°èˆªé¸ä¸­æ™‚çš„èƒŒæ™¯çƒ */
        .nav-indicator {
            position: absolute; top: 6px; bottom: 6px; z-index: 0;
            background: #F1F5F9; border-radius: 99px;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* ğŸ­ å­—é«”èˆ‡æ’ç‰ˆ */
        .font-serif { font-family: 'Playfair Display', serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* âœ¨ å‹•ç•« */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .modal-enter { animation: modalFloat 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalFloat { from { opacity: 0; transform: translateY(60px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .loader {
            width: 48px; height: 48px; border: 4px solid #E2E8F0; border-radius: 50%; display: inline-block; position: relative;
            animation: rotation 1s linear infinite;
        }
        .loader::after {
            content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 48px; height: 48px; border-radius: 50%; border: 4px solid transparent; border-top-color: var(--c-orange);
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ¨™ç±¤ Tag */
        .tag-pill {
            background: #FFF; border: 1px solid #E2E8F0; color: #64748B;
            border-radius: 8px; font-weight: 600; transition: all 0.2s;
        }
        .tag-pill.active {
            background: #FFF7ED; border-color: #FB923C; color: #EA580C;
            box-shadow: 0 4px 12px -2px rgba(251, 146, 60, 0.2);
        }
    </style>
</head>
<body class="flex flex-col items-center p-4 sm:p-6 pb-32">

    <div class="film-grain"></div>
    <div class="ambient-light light-1"></div>
    <div class="ambient-light light-2"></div>
    <div class="ambient-light light-3"></div>

    <div id="app" class="w-full max-w-lg relative z-10">
        
        <div v-if="isSubmitting" class="fixed inset-0 z-[999] bg-white/80 backdrop-blur-xl flex flex-col items-center justify-center">
            <span class="loader mb-6"></span>
            <div class="text-xl font-serif italic text-slate-500">Writing to cloud...</div>
        </div>

        <div v-if="!loading && !currentUser && !isSubmitting" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-white/60 backdrop-blur-md">
            <div class="glass-panel p-10 w-full max-w-xs text-center modal-enter shadow-2xl">
                <div class="w-20 h-20 bg-gradient-to-br from-orange-100 to-white rounded-full mx-auto mb-6 flex items-center justify-center text-4xl shadow-inner border border-white">ğŸ—»</div>
                <h3 class="text-3xl font-serif text-slate-800 mb-2 font-bold">TranStation</h3>
                <p class="text-xs font-mono text-slate-400 mb-10 tracking-[0.2em] uppercase">Creative Research Lab</p>
                
                <div class="relative group">
                    <select v-model="tempUser" class="appearance-none w-full bg-white border border-slate-200 rounded-2xl py-4 px-6 text-center text-lg text-slate-700 outline-none cursor-pointer hover:border-orange-300 transition-colors font-bold shadow-sm">
                        <option disabled value="">- é¸æ“‡å¤¥ä¼´ -</option>
                        <option v-for="u in users" :key="u.id" :value="u">{{ u.name }}</option>
                    </select>
                    <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none text-slate-400">â–¼</div>
                </div>

                <button @click="confirmIdentity" :disabled="!tempUser" class="w-full btn-campfire py-4 text-lg mt-8 shadow-xl hover:scale-[1.02]">
                    ç™»å…¥ç³»çµ±
                </button>
            </div>
        </div>

        <header class="flex justify-between items-end mb-10 px-2 mt-8">
            <div class="animate-[modalFloat_0.6s]">
                <div class="flex items-center gap-2 mb-2 opacity-80">
                    <span class="w-2 h-2 rounded-full bg-[#FB923C]"></span>
                    <h1 class="text-[10px] tracking-[0.3em] font-bold text-slate-500 uppercase">Financial OS</h1>
                </div>
                <h2 class="text-4xl font-serif text-slate-800 leading-none drop-shadow-sm">
                    è½‰é§…å‰µç ” <span class="block text-lg font-sans font-bold text-slate-400 mt-1 tracking-widest">é ç®—å¸³å‹™ç³»çµ± v19</span>
                </h2>
            </div>
            <div class="flex flex-col items-end gap-3">
                 <button @click="forceRefresh" class="w-12 h-12 rounded-full bg-white/60 hover:bg-white backdrop-blur-md flex items-center justify-center border border-white shadow-sm transition-all group">
                    <span class="group-hover:rotate-180 transition-transform duration-700 text-slate-500">â†»</span>
                 </button>
                 <div v-if="currentUser" class="px-4 py-1.5 bg-white/60 backdrop-blur-md border border-white text-slate-600 rounded-full text-xs font-bold font-mono flex items-center gap-2 shadow-sm">
                    <span class="w-1.5 h-1.5 rounded-full bg-[#10B981] animate-pulse"></span>
                    {{ currentUser.name }}
                </div>
            </div>
        </header>

        <main class="flex flex-col gap-6 relative min-h-[600px]">
            
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-panel p-5 relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-100/50 rounded-full blur-2xl group-hover:bg-blue-200/50 transition-colors"></div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">ç´¯è¨ˆç‡Ÿæ”¶ Revenue</div>
                    <div class="text-2xl font-serif font-bold text-slate-800">${{ formatCompact(globalStats.revenue) }}</div>
                </div>
                <div class="glass-panel p-5 relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-green-100/50 rounded-full blur-2xl group-hover:bg-green-200/50 transition-colors"></div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">ç¾é‡‘æ°´ä½ Liquid</div>
                    <div class="text-2xl font-serif font-bold text-[#10B981]">${{ formatCompact(globalStats.cash) }}</div>
                </div>
            </div>

            <transition name="fade" mode="out-in">
                
                <div v-if="tab==='dashboard'" class="space-y-5 pb-24">
                    <div v-for="(stat, pid) in projectStats" :key="pid" @click="openProjectDetail(stat, pid)" 
                         class="glass-panel p-6 cursor-pointer hover:bg-white/80 transition-all duration-300 group border-l-4 border-l-transparent hover:border-l-[#FB923C]">
                        
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="text-2xl font-serif text-slate-800 mb-1 group-hover:text-[#FB923C] transition-colors">{{ stat.name }}</h3>
                                <span class="inline-block px-2 py-1 bg-slate-100 rounded-md text-[10px] font-mono text-slate-500">æŠ½æˆ {{ stat.retentionRate }}%</span>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] font-mono text-slate-400 uppercase tracking-widest mb-1">Safe Budget</div>
                                <div class="text-xl font-mono font-bold text-slate-700">${{ formatCompact(stat.safeBalance) }}</div>
                            </div>
                        </div>

                        <div class="fuel-track w-full mb-4">
                            <div class="fuel-bar"
                                 :class="stat.safeBalance < 0 ? 'bg-gradient-to-r from-red-400 to-red-500' : ''"
                                 :style="{width: Math.max(0, Math.min((stat.safeBalance/stat.safeBudget)*100, 100)) + '%'}">
                                 <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent w-1/2 skew-x-12 translate-x-[-150%] animate-[shimmer_2.5s_infinite]"></div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                            <div class="text-[10px] font-bold text-slate-400">ç¾é‡‘æµ (Cash Flow)</div>
                            <div class="text-sm font-mono font-bold" :class="stat.cashBalance < 0 ? 'text-[#F43F5E]' : 'text-[#10B981]'">
                                {{ stat.cashBalance < 0 ? 'âˆ’' : '+' }}${{ formatCompact(Math.abs(stat.cashBalance)) }}
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="tab==='expense'" class="glass-panel p-6 pb-24 border-t-4 border-t-[#FB923C]">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="text-2xl p-2 bg-orange-100 rounded-full">âœï¸</span>
                        <h3 class="text-xl font-serif text-slate-800">æ–°å¢æ”¯å‡ºç´€éŒ„</h3>
                    </div>
                    
                    <div class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase pl-1">æ—¥æœŸ</label>
                                <input type="date" v-model="form.date" class="clean-input w-full font-mono text-sm">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase pl-1">ä»˜æ¬¾äºº</label>
                                <select v-model="form.payer" class="clean-input w-full text-sm font-bold text-[#EA580C]">
                                    <option v-for="u in users" :value="u.name">{{ u.name }}</option>
                                </select>
                            </div>
                        </div>

                        <div class="h-px bg-slate-100 w-full"></div>

                        <div v-for="(item, idx) in form.items" :key="idx" class="animate-[modalFloat_0.3s]">
                            <div class="relative bg-white/40 p-5 rounded-2xl border border-white space-y-4 hover:shadow-md transition-all">
                                <button v-if="form.items.length>1" @click="form.items.splice(idx,1)" class="absolute top-2 right-2 text-slate-300 hover:text-[#F43F5E] text-lg transition-colors">Ã—</button>
                                
                                <div class="flex gap-3">
                                    <div class="flex-[2]">
                                        <select v-model="item.projectId" class="clean-input w-full text-sm py-3 border-none bg-white">
                                            <option disabled value="">é¸æ“‡å°ˆæ¡ˆ...</option>
                                            <option v-for="p in projects" :value="p.id">{{ p.name }}</option>
                                        </select>
                                    </div>
                                    <div class="flex-1">
                                        <input type="number" v-model.number="item.amount" placeholder="$0" class="clean-input w-full text-lg text-right font-mono py-3 border-none bg-white text-[#EA580C]">
                                    </div>
                                </div>

                                <div v-if="item.projectId && getProjectBudgetLines(item.projectId).length > 0" class="flex flex-wrap gap-2">
                                    <div v-for="line in getProjectBudgetLines(item.projectId)" 
                                         @click="item.category = line.category"
                                         class="tag-pill px-3 py-1.5 text-[10px] cursor-pointer"
                                         :class="item.category === line.category ? 'active' : 'hover:bg-slate-50'">
                                        {{ line.category }}
                                    </div>
                                </div>

                                <input type="text" v-model="item.itemName" placeholder="å“é …èªªæ˜ (å¦‚: é«˜éµç¥¨ã€å™¨æç§Ÿå€Ÿ)" class="w-full bg-transparent text-sm border-b border-slate-200 p-2 focus:outline-none focus:border-[#FB923C] placeholder-slate-400 font-medium text-slate-700 transition-colors">
                            </div>
                        </div>

                        <button @click="form.items.push({projectId:'',amount:'',itemName:'',category:''})" class="w-full py-4 border border-dashed border-slate-300 text-slate-400 rounded-2xl text-xs font-bold hover:border-[#FB923C] hover:text-[#FB923C] hover:bg-orange-50 transition-colors tracking-widest">+ å¢åŠ ä¸€ç­†</button>
                    </div>

                    <div class="mt-8">
                         <button @click="submitExpense" class="w-full btn-campfire py-4 text-sm tracking-[0.2em] shadow-xl flex items-center justify-center gap-3 hover:scale-[1.02]">
                            <span>ç¢ºèªè¨˜å¸³</span>
                            <span class="bg-black/10 px-2 py-0.5 rounded text-xs font-mono border border-white/20">${{ totalExpense.toLocaleString() }}</span>
                        </button>
                    </div>
                </div>

                <div v-else-if="tab==='funds'" class="pb-24 space-y-4">
                    <div class="glass-panel p-6">
                        <div class="flex justify-between items-center mb-8">
                             <h3 class="text-xl font-serif text-slate-800">äººå“¡è³‡é‡‘ç‹€æ…‹</h3>
                             <button @click="showTransferModal=true" class="w-10 h-10 rounded-full bg-orange-100 text-[#EA580C] flex items-center justify-center hover:bg-[#FB923C] hover:text-white transition-colors text-xl shadow-sm">ï¼‹</button>
                        </div>
                        
                        <div class="space-y-8">
                            <div v-for="u in userStatusList" :key="u.id" @click="openUserHistory(u)" class="cursor-pointer group">
                                <div class="flex justify-between text-xs font-bold mb-2 font-mono">
                                    <span class="text-slate-500 group-hover:text-slate-800 transition-colors">{{ u.name }}</span>
                                    <span :class="u.balance < 0 ? 'text-[#F43F5E]' : 'text-[#10B981]'">{{ u.balance < 0 ? '' : '+' }}${{ formatCompact(u.balance) }}</span>
                                </div>
                                <div class="h-3 w-full bg-slate-100 rounded-full overflow-hidden relative border border-slate-100 shadow-inner">
                                    <div class="absolute left-1/2 top-0 bottom-0 w-px bg-slate-300 z-10"></div>
                                    
                                    <div class="w-1/2 h-full absolute right-1/2 flex justify-end">
                                        <div v-if="u.balance < 0" class="h-full bg-gradient-to-l from-red-400 to-red-500 rounded-l-full" :style="{width: Math.min((Math.abs(u.balance)/maxUserBalance)*100, 100) + '%'}"></div>
                                    </div>
                                    <div class="w-1/2 h-full absolute left-1/2 flex justify-start">
                                        <div v-if="u.balance > 0" class="h-full bg-gradient-to-r from-emerald-400 to-emerald-500 rounded-r-full" :style="{width: Math.min((u.balance/maxUserBalance)*100, 100) + '%'}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-else-if="tab==='income'" class="glass-panel p-6 pb-24">
                     <h3 class="text-xl font-serif text-slate-800 mb-6">æ–°å¢å°ˆæ¡ˆ</h3>
                     <div class="space-y-5">
                        <div class="flex gap-3">
                            <input type="text" v-model="newProj.name" placeholder="å°ˆæ¡ˆåç¨±" class="clean-input flex-[2] text-sm">
                            <input type="number" v-model.number="newProj.retention" placeholder="æŠ½æˆ%" class="clean-input flex-1 text-sm text-center font-bold text-[#EA580C] border-orange-200">
                        </div>
                        <input type="number" v-model.number="newProj.budget" placeholder="ç¸½é ç®— ($)" class="clean-input w-full text-sm font-mono">
                        <button @click="createProject" class="w-full btn-campfire py-4 text-xs font-bold shadow-lg mt-2">å»ºç«‹å°ˆæ¡ˆ</button>
                     </div>
                </div>

            </transition>
        </main>

        <div class="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-40 w-[90%] max-w-[360px]">
            <nav class="island-nav">
                <div class="nav-indicator" :style="indicatorStyle"></div>
                
                <div class="nav-item" :class="{active: tab==='dashboard'}" @click="tab='dashboard'">å°ˆæ¡ˆ</div>
                <div class="nav-item" :class="{active: tab==='funds'}" @click="tab='funds'">å„äºº</div>
                <div class="nav-item" :class="{active: tab==='expense'}" @click="tab='expense'">è¨˜å¸³</div>
                <div class="nav-item" :class="{active: tab==='income'}" @click="tab='income'">é€²å¸³</div>
            </nav>
        </div>

        <div v-if="selectedProject" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/20 backdrop-blur-sm" @click.self="selectedProject=null">
            <div class="bg-[#FDFBF9] w-full max-w-sm h-[80vh] rounded-[32px] flex flex-col shadow-2xl overflow-hidden modal-enter relative border border-white">
                <div class="absolute top-0 left-0 w-full h-40 bg-gradient-to-b from-orange-100/60 to-transparent z-0"></div>
                
                <div class="p-6 pb-2 border-b border-slate-100 bg-white/80 backdrop-blur-md sticky top-0 z-20">
                    <div class="flex justify-between items-start mb-1">
                        <h2 class="text-3xl font-serif text-slate-800">{{ selectedProject.name }}</h2>
                        <button @click="selectedProject=null" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 transition-colors">Ã—</button>
                    </div>
                    <div class="text-[10px] font-mono text-slate-400 font-bold tracking-widest uppercase">ID: {{ selectedProject.id }}</div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-10 relative z-10">
                    
                    <div>
                        <div class="flex justify-between items-end mb-4">
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest">é ç®—å‰©é¤˜é‡</h4>
                            <button @click="showAddBudgetLine=!showAddBudgetLine" class="text-[10px] bg-slate-100 text-slate-600 px-3 py-1 rounded-full hover:bg-orange-100 hover:text-orange-600 transition-colors font-bold">+ æ–°å¢ç§‘ç›®</button>
                        </div>
                        
                        <div v-if="showAddBudgetLine" class="mb-4 bg-white p-3 rounded-xl flex gap-2 border border-slate-100 shadow-sm animate-[modalFloat_0.2s]">
                            <input type="text" v-model="newBudget.category" placeholder="ç§‘ç›®" class="bg-slate-50 rounded-lg px-2 py-2 text-xs w-1/3 outline-none text-slate-800 border border-slate-200">
                            <input type="number" v-model.number="newBudget.amount" placeholder="$" class="bg-slate-50 rounded-lg px-2 py-2 text-xs flex-1 outline-none font-mono text-slate-800 border border-slate-200">
                            <button @click="addBudgetLine" class="text-xs font-bold px-3 bg-[#FB923C] text-white rounded-lg">OK</button>
                        </div>

                        <div class="space-y-5">
                            <div v-for="line in selectedProject.budgetLines" :key="line.category">
                                <div class="flex justify-between mb-2 text-xs">
                                    <span class="font-bold text-slate-700 flex items-center gap-2">
                                        {{ line.category }}
                                        <span v-if="line.used > line.budget" class="text-[9px] bg-red-100 text-red-600 px-1.5 rounded font-bold">è¶…æ”¯</span>
                                    </span>
                                    <span class="font-mono" :class="(line.budget - line.used) < 0 ? 'text-red-500 font-bold' : 'text-slate-400'">
                                        é¤˜ ${{ (line.budget - line.used).toLocaleString() }} <span class="text-slate-300">/ {{ formatCompact(line.budget) }}</span>
                                    </span>
                                </div>
                                <div class="fuel-track w-full">
                                    <div class="fuel-bar"
                                         :class="(line.budget - line.used) < 0 ? 'bg-gradient-to-r from-red-400 to-red-600' : ''"
                                         :style="{width: Math.max(0, Math.min(((line.budget - line.used)/line.budget)*100, 100)) + '%'}">
                                    </div>
                                </div>
                            </div>
                             <div v-if="!selectedProject.budgetLines.length" class="text-center text-[10px] text-slate-400 py-6 border border-dashed border-slate-200 rounded-xl">å°šæœªè¨­å®šé ç®—ç´°é …</div>
                        </div>
                    </div>

                    <div>
                         <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6">é€²å¸³é‡Œç¨‹ç¢‘</h4>
                         <div class="pl-2 border-l-2 border-slate-100 ml-2 space-y-6">
                            <div v-for="term in selectedProject.incomeTerms" :key="term.id" class="relative pl-6">
                                <div class="absolute -left-[7px] top-1.5 w-3 h-3 rounded-full border-4 border-[#FDFBF9]" :class="term.status==='received' ? 'bg-[#10B981]' : 'bg-slate-300'"></div>
                                <div class="flex justify-between items-center group bg-white p-3 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all">
                                    <div>
                                        <div class="text-xs font-bold text-slate-800 group-hover:text-[#EA580C] transition-colors">{{ term.termName }}</div>
                                        <div class="text-[10px] font-mono text-slate-400">${{ term.amount.toLocaleString() }}</div>
                                    </div>
                                    <button v-if="term.status==='pending'" @click="confirmIncome(term)" class="text-[10px] bg-slate-900 text-white px-3 py-1 rounded-full font-bold hover:bg-[#EA580C] transition-colors">ç¢ºèªå…¥å¸³</button>
                                    <div v-else class="text-[10px] font-mono font-bold text-[#10B981]">å·²å…¥å¸³</div>
                                </div>
                            </div>
                            <div class="relative pl-6">
                                <div class="absolute -left-[5px] top-2 w-2 h-2 rounded-full bg-slate-200"></div>
                                <div class="flex gap-2 opacity-50 hover:opacity-100 transition-opacity">
                                    <input type="text" v-model="newTerm.name" placeholder="æœŸæ•¸åç¨±" class="bg-transparent border-b border-slate-200 text-xs w-20 outline-none text-slate-800 placeholder-slate-400">
                                    <input type="number" v-model.number="newTerm.amount" placeholder="$" class="bg-transparent border-b border-slate-200 text-xs w-20 outline-none font-mono text-slate-800 placeholder-slate-400">
                                    <button @click="addTerm" class="text-xs text-slate-500 font-bold bg-slate-100 px-2 rounded hover:bg-slate-200">+</button>
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showTransferModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/20 backdrop-blur-sm" @click.self="showTransferModal=false">
            <div class="glass-panel p-8 w-full max-w-sm modal-enter bg-white shadow-2xl">
                <h3 class="text-2xl font-serif text-slate-800 mb-6">è³‡é‡‘è½‰ç§»</h3>
                <div class="space-y-4">
                    <select v-model="transferForm.projectId" class="clean-input w-full text-sm py-3 bg-white">
                        <option disabled value="">è³‡é‡‘ä¾†æºå°ˆæ¡ˆ</option>
                        <option v-for="p in projects" :value="p.id">{{ p.name }}</option>
                    </select>
                    <div class="flex gap-3">
                        <select v-model="transferForm.targetUser" class="clean-input flex-1 text-sm py-3 bg-white font-bold text-[#EA580C]">
                            <option v-for="u in users" :value="u.name">{{ u.name }}</option>
                        </select>
                        <input type="number" v-model.number="transferForm.amount" placeholder="$" class="clean-input w-1/3 text-lg font-mono text-center bg-white">
                    </div>
                    <input type="text" v-model="transferForm.note" placeholder="å‚™è¨»" class="clean-input w-full text-sm py-3 bg-white">
                    <button @click="submitTransfer" class="w-full btn-campfire py-3 text-sm mt-2 shadow-lg">ç¢ºèªåŸ·è¡Œ</button>
                </div>
            </div>
        </div>

        <div v-if="selectedUser" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/20 backdrop-blur-sm" @click.self="selectedUser=null">
             <div class="bg-[#FDFBF9] w-full max-w-sm h-[80vh] rounded-[32px] flex flex-col shadow-2xl overflow-hidden modal-enter border border-white">
                <div class="p-6 border-b border-slate-100 bg-white/50 backdrop-blur">
                    <h3 class="text-2xl font-serif text-slate-800">{{ selectedUser.name }}</h3>
                    <div class="text-2xl font-mono font-bold mt-2" :class="selectedUser.balance<0?'text-[#F43F5E]':'text-[#10B981]'">
                        ${{ formatCompact(selectedUser.balance) }}
                    </div>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest mt-1">ç›®å‰é¤˜é¡</p>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-3 bg-[#F9F7F5]">
                    <div v-for="tx in getUserHistory(selectedUser.name)" :key="tx.id" class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div v-if="editingTx !== tx.id" class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-xs text-slate-800 mb-0.5">{{ tx.item || tx.note || 'è³‡é‡‘è½‰ç§»' }}</div>
                                <div class="text-[10px] text-slate-400 font-mono">{{ tx.date }} Â· {{ tx.project }}</div>
                                <span v-if="tx.category" class="inline-block mt-1 text-[9px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">{{ tx.category }}</span>
                            </div>
                            <div class="text-right">
                                <div class="font-mono font-bold text-sm" :class="tx.isIncome ? 'text-[#10B981]' : 'text-[#F43F5E]'">{{ tx.isIncome ? '+' : '-' }}${{ tx.amount.toLocaleString() }}</div>
                                <div class="flex gap-3 justify-end mt-1">
                                    <button v-if="!tx.isIncome" @click="startEdit(tx)" class="text-[10px] text-slate-400 hover:text-[#EA580C] transition-colors">ä¿®æ”¹</button>
                                    <button @click="deleteTransaction(tx)" class="text-[10px] text-slate-400 hover:text-[#F43F5E] transition-colors">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                        <div v-else class="space-y-2 bg-slate-50 p-2 rounded-xl border border-slate-200">
                             <div class="flex gap-2">
                                <input type="date" v-model="editForm.date" class="bg-white text-xs p-2 rounded w-full text-slate-700 border border-slate-200">
                                <input type="number" v-model.number="editForm.amount" class="bg-white text-xs p-2 rounded w-full font-mono font-bold text-[#F43F5E] border border-slate-200">
                             </div>
                             <input type="text" v-model="editForm.item" class="bg-white text-xs p-2 rounded w-full text-slate-700 border border-slate-200">
                             <div class="flex gap-2 pt-1">
                                 <button @click="cancelEdit" class="flex-1 py-2 bg-slate-200 rounded text-xs text-slate-500">å–æ¶ˆ</button>
                                 <button @click="saveEdit(tx)" class="flex-1 py-2 bg-[#FB923C] text-white rounded text-xs font-bold">å„²å­˜</button>
                             </div>
                        </div>
                    </div>
                </div>
             </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyKtICKtLnl01vytLz90174UICy1bfdMbKQdRqeZX3KOhyQGwJNQyXQDouxnXXfEfLQ/exec'; 

        createApp({
            setup() {
                const currentUser = ref(null);
                const tempUser = ref(null);
                const loading = ref(false);
                const isSubmitting = ref(false);
                const tab = ref('dashboard');
                const autoRefreshTimer = ref(30);
                
                const users = ref([]);
                const projects = ref([]);
                const projectStats = ref({});
                const allTransactions = ref([]); 
                
                const form = ref({ date: new Date().toISOString().split('T')[0], payer: '', items: [{projectId:'',amount:'',itemName:'',category:''}] });
                const transferForm = ref({ projectId: '', targetUser: '', amount: '', note: '' });
                const newProj = ref({ name: '', budget: '', retention: 10 });
                const newTerm = ref({ name: '', amount: '' });
                
                const showAddBudgetLine = ref(false);
                const newBudget = ref({ category: '', amount: '' });
                const editingTx = ref(null);
                const editForm = ref({});
                
                const showTransferModal = ref(false);
                const selectedUser = ref(null);
                const selectedProject = ref(null);

                // è¨ˆç®—å°èˆªæ¢èƒŒæ™¯çš„ä½ç½®
                const indicatorStyle = computed(() => {
                    const tabs = ['dashboard', 'funds', 'expense', 'income'];
                    const index = tabs.indexOf(tab.value);
                    return {
                        left: `${index * 25}%`,
                        width: '25%'
                    };
                });

                onMounted(() => {
                    loadData();
                    setInterval(() => {
                        if (autoRefreshTimer.value > 0) autoRefreshTimer.value--;
                        else { loadData(true); autoRefreshTimer.value = 30; }
                    }, 1000);
                });

                const forceRefresh = () => { loadData(); autoRefreshTimer.value = 30; };

                const loadData = async (silent = false) => {
                    if(!silent) loading.value = true;
                    try {
                        const res = await fetch(`${GAS_API_URL}?op=getData`);
                        const data = await res.json();
                        users.value = data.users;
                        projects.value = data.projects;
                        projectStats.value = data.projectStats;
                        allTransactions.value = data.allTransactions;
                        
                        if(currentUser.value) currentUser.value = users.value.find(x => x.name === currentUser.value.name) || currentUser.value;
                        if(selectedProject.value) selectedProject.value = { ...projectStats.value[selectedProject.value.id], id: selectedProject.value.id };
                        if(selectedUser.value) selectedUser.value = users.value.find(u => u.name === selectedUser.value.name) || selectedUser.value;

                    } catch(e) { console.error(e); }
                    if(!silent) loading.value = false;
                };

                const apiCall = async (payload) => {
                    isSubmitting.value = true;
                    try {
                        await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({...payload, operator: currentUser.value?.name}), headers: {'Content-Type': 'text/plain'} });
                        await loadData();
                        return true;
                    } catch(e) { alert('é€£ç·šéŒ¯èª¤'); return false; } 
                    finally { setTimeout(() => isSubmitting.value = false, 800); }
                };

                const globalStats = computed(() => {
                    let revenue = 0, cash = 0, debt = 0;
                    Object.values(projectStats.value).forEach(p => {
                        p.incomeTerms.forEach(term => { if(term.status === 'received') revenue += term.amount; });
                        cash += p.cashBalance;
                    });
                    users.value.forEach(u => { if(u.pettyCash < 0) debt += Math.abs(u.pettyCash); });
                    return { revenue, cash, debt };
                });

                const totalExpense = computed(() => form.value.items.reduce((s,i)=>s+(Number(i.amount)||0),0));
                const userStatusList = computed(() => users.value.map(u => ({...u, balance: u.pettyCash})));
                const maxUserBalance = computed(() => { const max = Math.max(...users.value.map(u => Math.abs(u.pettyCash))); return max === 0 ? 1000 : max; });

                const confirmIdentity = () => { currentUser.value = tempUser.value; form.value.payer = currentUser.value.name; };
                const formatCompact = (n) => new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(n);

                const submitExpense = async () => {
                    const items = form.value.items.map(i => ({...i, projectName: projects.value.find(p=>p.id===i.projectId)?.name}));
                    if(await apiCall({ action: 'expense', date: form.value.date, payer: form.value.payer, items })) {
                        form.value.items = [{projectId:'',amount:'',itemName:'',category:''}];
                        tab.value = 'dashboard';
                    }
                };
                
                const addBudgetLine = async () => {
                    if(!newBudget.value.category || !newBudget.value.amount) return;
                    await apiCall({ action: 'addBudgetLine', projectId: selectedProject.value.id, ...newBudget.value });
                    newBudget.value = { category: '', amount: '' }; showAddBudgetLine.value = false;
                };

                const getProjectBudgetLines = (pid) => { return projectStats.value[pid]?.budgetLines || []; };
                const startEdit = (tx) => { editingTx.value = tx.id; editForm.value = { ...tx }; };
                const cancelEdit = () => { editingTx.value = null; editForm.value = {}; };
                const saveEdit = async (originalTx) => { if(await apiCall({ action: 'editTransaction', ...editForm.value })) { editingTx.value = null; } };
                const deleteTransaction = async (tx) => { if(confirm(`ç¢ºå®šåˆªé™¤ ${tx.item || 'æ­¤ç­†ç´€éŒ„'} $${tx.amount}?`)) await apiCall({ action: 'deleteTransaction', id: tx.id, type: tx.type }); };
                const submitTransfer = async () => { const pName = projects.value.find(p=>p.id===transferForm.value.projectId)?.name; if(await apiCall({ action: 'transfer', ...transferForm.value, projectName: pName })) { showTransferModal.value = false; transferForm.value = { projectId: '', targetUser: '', amount: '', note: '' }; } };
                const createProject = async () => { if(await apiCall({ action: 'createProject', ...newProj.value })) { newProj.value = { name: '', budget: '', retention: 10 }; } };
                const addTerm = async () => { if(!selectedProject.value || !newTerm.value.amount) return; await apiCall({ action: 'addTerm', projectId: selectedProject.value.id, ...newTerm.value }); newTerm.value = { name: '', amount: '' }; };
                const confirmIncome = async (term) => { if(confirm(`ç¢ºèªå·²æ”¶åˆ°æ¬¾é … $${term.amount}?`)) await apiCall({ action: 'confirmIncome', id: term.id }); };
                
                const openUserHistory = (u) => selectedUser.value = u;
                const getUserHistory = (name) => allTransactions.value.filter(tx => tx.relatedUser === name).sort((a,b)=>new Date(b.date)-new Date(a.date));
                const openProjectDetail = (stat, pid) => selectedProject.value = { id: pid, ...stat };

                return {
                    currentUser, tempUser, loading, isSubmitting, tab, autoRefreshTimer,
                    users, projects, projectStats, userStatusList, maxUserBalance, globalStats,
                    form, transferForm, newProj, newTerm, totalExpense,
                    showTransferModal, selectedUser, selectedProject,
                    showAddBudgetLine, newBudget, editingTx, editForm, indicatorStyle,
                    confirmIdentity, formatCompact, submitExpense, submitTransfer, createProject,
                    openUserHistory, getUserHistory, openProjectDetail,
                    addTerm, confirmIncome, deleteTransaction, loadData, forceRefresh,
                    addBudgetLine, getProjectBudgetLines, startEdit, cancelEdit, saveEdit
                };
            }
        }).mount('#app');
    </script>
</body>
</html>