<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½‰é§…å‰µç ” | é ç®—è¨˜å¸³ç®¡ç†ç³»çµ±</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FFF7ED; color: #431407; }
        .bg-blob { position: absolute; filter: blur(80px); opacity: 0.6; z-index: -1; animation: move 10s infinite alternate; }
        @keyframes move { from { transform: translate(0, 0) scale(1); } to { transform: translate(20px, -20px) scale(1.1); } }
        .glass-card { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 8px 32px rgba(249, 115, 22, 0.1); }
        .input-field { background: rgba(255, 255, 255, 0.8); border: 1px solid #FED7AA; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: #F97316; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1); }
        /* éŒ¯èª¤è¨Šæ¯å€å¡Š */
        .error-box { background: #FEF2F2; border: 1px solid #FCA5A5; color: #991B1B; font-size: 0.8rem; padding: 10px; border-radius: 8px; margin-top: 10px; word-break: break-all; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">

    <div class="bg-blob bg-orange-300 w-96 h-96 rounded-full top-0 left-0 mix-blend-multiply"></div>
    <div class="bg-blob bg-amber-200 w-96 h-96 rounded-full bottom-0 right-0 mix-blend-multiply animation-delay-2000"></div>

    <div id="app" class="w-full max-w-lg">
        
        <div class="glass-card rounded-3xl p-8 relative">
            
            <div class="mb-8 text-center">
                <div class="inline-block px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-bold tracking-wider mb-2">TranStation Lab</div>
                <h1 class="text-3xl font-bold text-stone-800 tracking-tight mb-1">é ç®—è¨˜å¸³ç³»çµ±</h1>
                <p class="text-stone-500 text-sm">è²¡å‹™é€æ˜ Â· å°ˆæ¡ˆåˆ†æµ Â· é’å¹´å…±å‰µ</p>
            </div>

            <div v-if="loading" class="flex flex-col items-center justify-center py-10 space-y-3">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-orange-500"></div>
                <p class="text-stone-500 text-sm animate-pulse">{{ statusMessage }}</p>
                <div v-if="errorMessage" class="error-box">
                    <strong>éŒ¯èª¤è©³æƒ…ï¼š</strong><br>
                    {{ errorMessage }}
                </div>
            </div>

            <form v-else @submit.prevent="submitForm" class="space-y-5">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 sm:col-span-1">
                        <label class="block text-xs font-bold text-stone-500 mb-1 ml-1">æ¶ˆè²»æ—¥æœŸ</label>
                        <input type="date" v-model="form.date" required class="input-field w-full rounded-xl px-4 py-2 text-stone-700">
                    </div>
                    
                    <div class="col-span-2 sm:col-span-1">
                        <label class="block text-xs font-bold text-stone-500 mb-1 ml-1">ç¶“æ‰‹äºº</label>
                        <select v-model="form.payer" required class="input-field w-full rounded-xl px-4 py-2 text-stone-700 appearance-none bg-white">
                            <option disabled value="">é¸æ“‡æˆå“¡</option>
                            <option v-for="u in users" :key="u.id" :value="u.name">{{ u.name }} (å‰© ${{ u.pettyCash }})</option>
                        </select>
                    </div>

                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-stone-500 mb-2 ml-1">è³‡é‡‘ä¾†æº</label>
                        <div class="flex space-x-2">
                            <button type="button" @click="form.paymentType = 'é›¶ç”¨é‡‘'" :class="form.paymentType === 'é›¶ç”¨é‡‘' ? 'bg-orange-500 text-white shadow-lg' : 'bg-white text-stone-500 hover:bg-orange-50'" class="flex-1 py-2 rounded-xl text-sm font-medium transition-all">ğŸŒ² å…¬å¸é›¶ç”¨é‡‘</button>
                            <button type="button" @click="form.paymentType = 'ä»£å¢Š'" :class="form.paymentType === 'ä»£å¢Š' ? 'bg-orange-500 text-white shadow-lg' : 'bg-white text-stone-500 hover:bg-orange-50'" class="flex-1 py-2 rounded-xl text-sm font-medium transition-all">ğŸ™‹ å€‹äººå…ˆå¢Š</button>
                        </div>
                    </div>
                </div>

                <hr class="border-stone-200 border-dashed my-4">

                <div>
                    <div class="flex justify-between items-end mb-2">
                        <label class="block text-xs font-bold text-stone-500 ml-1">æ¶ˆè²»æ˜ç´°</label>
                        <span class="text-xs text-orange-600 font-bold bg-orange-100 px-2 py-0.5 rounded-md">ç¸½è¨ˆ: ${{ totalAmount }}</span>
                    </div>

                    <div class="space-y-3">
                        <div v-for="(item, index) in form.items" :key="index" class="bg-white/50 p-3 rounded-xl border border-white relative group hover:shadow-sm transition-all">
                            <button v-if="form.items.length > 1" @click="removeItem(index)" type="button" class="absolute -top-2 -right-2 bg-red-100 text-red-400 rounded-full p-1 hover:bg-red-500 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                            </button>
                            <div class="flex space-x-2 mb-2">
                                <select v-model="item.projectId" required class="flex-[2] input-field rounded-lg px-2 py-1.5 text-sm">
                                    <option disabled value="">æ­¸å±¬å°ˆæ¡ˆ...</option>
                                    <option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</option>
                                </select>
                                <input type="number" v-model.number="item.amount" placeholder="$é‡‘é¡" required class="flex-1 input-field rounded-lg px-2 py-1.5 text-sm">
                            </div>
                            <div class="flex space-x-2">
                                <input type="text" v-model="item.itemName" placeholder="é …ç›®èªªæ˜..." required class="flex-[2] input-field rounded-lg px-2 py-1.5 text-sm">
                                <input type="text" v-model="item.note" placeholder="å‚™è¨»" class="flex-1 input-field rounded-lg px-2 py-1.5 text-sm">
                            </div>
                        </div>
                    </div>
                    <button type="button" @click="addItem" class="w-full mt-3 py-2 border border-dashed border-orange-300 text-orange-400 rounded-xl text-sm hover:bg-orange-50 hover:border-orange-500 transition-colors">+ æ–°å¢ä¸€ç­†æ‹†å¸³</button>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-gradient-to-r from-orange-500 to-amber-500 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 hover:scale-[1.02] active:scale-95 transition-all duration-300">ç¢ºèªå¯«å…¥å¸³æœ¬</button>
                </div>
            </form>
        </div>
        <p class="text-center text-stone-400 text-xs mt-6 opacity-60">TranStation Lab Â© 2025</p>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        // âš ï¸ è«‹å‹™å¿…ç¢ºèªé€™è£¡çš„ç¶²å€æ˜¯ä½ å‰›å‰›ã€Œå»ºç«‹æ–°ç‰ˆæœ¬ã€å¾Œæ‹¿åˆ°çš„æœ€æ–°ç¶²å€ï¼
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyKtICKtLnl01vytLz90174UICy1bfdMbKQdRqeZX3KOhyQGwJNQyXQDouxnXXfEfLQ/exec';

        createApp({
            setup() {
                const loading = ref(true);
                const statusMessage = ref('æ­£åœ¨é€£ç·šè½‰é§…è³‡æ–™åº«...');
                const errorMessage = ref(''); // ç”¨ä¾†é¡¯ç¤ºå…·é«”éŒ¯èª¤
                const projects = ref([]);
                const users = ref([]);
                
                const form = ref({
                    date: new Date().toISOString().split('T')[0],
                    payer: '',
                    paymentType: 'é›¶ç”¨é‡‘',
                    items: [{ projectId: '', itemName: '', amount: '', note: '' }]
                });

                const totalAmount = computed(() => form.value.items.reduce((sum, item) => sum + (Number(item.amount) || 0), 0));

                onMounted(async () => {
                    try {
                        // é€™è£¡ä½¿ç”¨ op=getData
                        const response = await fetch(`${GAS_API_URL}?op=getData`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP éŒ¯èª¤: ${response.status}`);
                        }

                        const data = await response.json();
                        
                        // æª¢æŸ¥å›å‚³è³‡æ–™çµæ§‹
                        if (!data.projects || !data.users) {
                            throw new Error('è³‡æ–™åº«å›å‚³æ ¼å¼æœ‰èª¤ï¼Œè«‹æª¢æŸ¥ GAS ä»£ç¢¼');
                        }

                        projects.value = data.projects;
                        users.value = data.users;
                        loading.value = false;

                    } catch (e) {
                        statusMessage.value = 'è®€å–å¤±æ•—';
                        errorMessage.value = e.message + " (è«‹æª¢æŸ¥ç¶²å€æˆ–æ¬Šé™)";
                        console.error('API Error:', e);
                    }
                });

                const addItem = () => form.value.items.push({ projectId: '', itemName: '', amount: '', note: '' });
                const removeItem = (index) => form.value.items.splice(index, 1);

                const submitForm = async () => {
                    loading.value = true;
                    statusMessage.value = 'æ­£åœ¨å¯«å…¥è³‡æ–™...';
                    errorMessage.value = ''; // æ¸…ç©ºéŒ¯èª¤
                    
                    const payload = { ...form.value, totalAmount: totalAmount.value };

                    try {
                        // ä½¿ç”¨ text/plain ç¹é CORS è¤‡é›œè«‹æ±‚
                        await fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload),
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                        });
                        
                        alert('âœ… å¯«å…¥æˆåŠŸï¼');
                        // é‡ç½®è¡¨å–®
                        form.value.items = [{ projectId: '', itemName: '', amount: '', note: '' }];
                        form.value.date = new Date().toISOString().split('T')[0];
                        
                        // é‡æ–°æŠ“å–è³‡æ–™æ›´æ–°é¤˜é¡
                        statusMessage.value = 'æ›´æ–°é¤˜é¡ä¸­...';
                        const res = await fetch(`${GAS_API_URL}?op=getData`);
                        const data = await res.json();
                        users.value = data.users;

                    } catch (e) {
                        alert('âŒ å¯«å…¥å¤±æ•—');
                        statusMessage.value = 'å¯«å…¥å¤±æ•—';
                        errorMessage.value = e.message;
                        console.error(e);
                    } finally {
                        loading.value = false;
                    }
                };

                return { loading, statusMessage, errorMessage, projects, users, form, totalAmount, addItem, removeItem, submitForm };
            }
        }).mount('#app');
    </script>
</body>
</html>